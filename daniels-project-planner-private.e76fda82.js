const e=(e,t)=>Math.round((t-e)/864e5);function t(e){if(!e||"string"!=typeof e)return null;e.includes("T")||e.includes("Z")||(e+="T00:00:00Z");let t=new Date(e);return isNaN(t.getTime())?null:new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()))}function n(e){if(!e||!(e instanceof Date)||isNaN(e))return"–";let t=String(e.getUTCDate()).padStart(2,"0"),n=String(e.getUTCMonth()+1).padStart(2,"0"),a=e.getUTCFullYear();return`${t}.${n}.${a}`}function a(e){return!e||!(e instanceof Date)||isNaN(e)?"":e.toISOString().split("T")[0]}function d(e,t){if(!e)return null;let n=new Date(e.getTime());if(t<=0)return n;let a=0;for(;a<t;)n.setUTCDate(n.getUTCDate()+1),0!==n.getUTCDay()&&6!==n.getUTCDay()&&a++;return n}function l(e,t){if(!e)return null;let n=new Date(e.getTime());if(t<=0)return n;let a=0;for(;a<t;)n.setUTCDate(n.getUTCDate()-1),0!==n.getUTCDay()&&6!==n.getUTCDay()&&a++;return n}function s(e,t){if(!e||!t||e.getTime()===t.getTime())return 0;let n=0,a=new Date(Math.min(e,t)),d=new Date(Math.max(e,t)),l=new Date(a);for(;l<=d;)0!==l.getUTCDay()&&6!==l.getUTCDay()&&n++,l.setUTCDate(l.getUTCDate()+1);return n=Math.max(0,n-1),e>t?-n:n}const i=e=>{let t=e.closest("tr"),n=e.closest(".team-section");return{teamId:n?n.dataset.teamId:null,taskId:t?parseInt(t.dataset.taskId):null}};function r(e){var n,i;let r=k.teams.find(t=>t.id===e);if(!r)return;let c=new Map(r.tasks.map(e=>[e.taskId,e])),p=new Map((r.baselines||[]).map(e=>[e.taskId,e])),u=null,m=null;r.tasks.forEach(e=>{e.cycleError=!1,e.plannedStart_date=t(e.plannedStart),e.plannedEnd_date=t(e.plannedEnd),e.actualEnd_date=t(e.actualEnd);let n=p.get(e.taskId);e.baseline=n?{...n,plannedEnd_date:t(n.plannedEnd)}:null;let a=parseInt(e.duration)||0,d=a>0?a-1:0;if(e.baseline&&e.baseline.plannedEnd_date){let t=l(e.baseline.plannedEnd_date,d);(!u||t<u)&&(u=t)}if(e.actualEnd_date){let t=l(e.actualEnd_date,d);(!m||t<m)&&(m=t)}});let g=0;u&&m&&m>u&&(g=s(u,m));let f=r.tasks.some(e=>!!e.actualEnd_date),y=new Set;r.tasks.forEach(e=>{(e.dependency||[]).forEach(e=>y.add(parseInt(e)))}),r.tasks.forEach(e=>e.isTerminal=!y.has(e.taskId));let{hasCycle:h,cycleNodes:b,sorted:w}=o(r.tasks);if(h)return void b.forEach(e=>{c.has(e)&&(c.get(e).cycleError=!0)});"forward"===r.planningMode?(n=c,w.forEach(e=>{let t=n.get(e),a=parseInt(t.duration)||0,l=t.plannedStart_date||null,s=null;t.dependency&&t.dependency.length>0&&t.dependency.forEach(e=>{let t=n.get(parseInt(e));if(t){let e=t.plannedEnd_date;e&&(!s||e>s)&&(s=e)}});let i=s?d(s,1):null,r=null;t.plannedStart_date=r=i&&l?i>l?i:l:i||l||null,r?t.plannedEnd_date=d(r,a>0?a-1:0):t.plannedEnd_date=null}),function(e,t,n,a){let l=new Map;n.forEach(e=>{let n,s=t.get(e),i=parseInt(s.duration)||0;if(s.actualEnd_date)n=s.actualEnd_date;else{let e=null,t=!0;if(s.dependency&&s.dependency.length>0){let n=null;s.dependency.forEach(e=>{let t=parseInt(e),a=l.get(t);a&&(!n||a>n)&&(n=a)}),n&&(e=d(n,1),t=!1)}if(e||(e=s.plannedStart_date),e){let l=t?d(e,a):e;n=d(l,i>0?i-1:0)}else n=null}l.set(e,n)}),t.forEach(e=>{let t=l.get(e.taskId),n=e.plannedEnd_date;t?e.forwardEnd_date=t:n?e.forwardEnd_date=n:e.forwardEnd_date=null})}(0,c,w,g)):(function(e,t){let n=new Map;e.forEach(e=>n.set(e.taskId,[])),e.forEach(e=>{(e.dependency||[]).forEach(t=>{let a=parseInt(t);n.has(a)&&n.get(a).push(e.taskId)})});for(let a=t.length-1;a>=0;a--){let d,s=t[a],i=e.get(s),r=parseInt(i.duration)||0,o=r>0?r-1:0;if(i.isTerminal)d=i.plannedEnd_date;else{let t=n.get(s),a=null;t&&t.length>0&&t.forEach(t=>{let n=e.get(t);n&&n.plannedStart_date&&(null===a||n.plannedStart_date<a)&&(a=n.plannedStart_date)}),d=a?l(a,1):null}i.plannedEnd_date=d,i.plannedEnd_date?i.plannedStart_date=l(i.plannedEnd_date,o):i.plannedStart_date=null}}(c,w),function(e,t,n,a){let l=new Map,s=new Set;t.forEach(t=>{let n,a=e.get(t),i=parseInt(a.duration)||0;if(a.actualEnd_date){l.set(t,a.actualEnd_date),s.add(t);return}let r=null,o=!1;if(a.dependency&&a.dependency.length>0&&a.dependency.forEach(e=>{let t=parseInt(e),n=l.get(t);n&&((!r||n>r)&&(r=n),s.has(t)&&(o=!0))}),r?(n=d(r,1),o&&s.add(t)):n=a.plannedStart_date,n){let e=d(n,i>0?i-1:0);l.set(t,e)}}),e.forEach(e=>{if(e.actualEnd_date){e.forwardEnd_date=e.actualEnd_date;return}let t=l.get(e.taskId);if(s.has(e.taskId))e.forwardEnd_date=t;else{let t=a&&e.baseline?.plannedEnd_date||e.plannedEnd_date,l=null;t&&(l=n>0?d(t,n):t),e.forwardEnd_date=l}})}(c,w,g,f)),i=r,c.forEach(e=>{let t="baseline"===i.delayReference&&e.baseline?e.baseline.plannedEnd_date:e.plannedEnd_date;t&&e.forwardEnd_date?e.delay=s(t,e.forwardEnd_date):e.delay=null,"Blocked"!==e.status&&(e.status=e.actualEnd_date?"Completed":"Not Started"),e.plannedStart=a(e.plannedStart_date),e.plannedEnd=a(e.plannedEnd_date),e.forwardEnd=a(e.forwardEnd_date)}),r.criticalPath=function(e){let t=new Map(e.tasks.map(e=>[e.taskId,e])),n=new Set;if(0===e.tasks.length)return n;let a=null;if(e.tasks.forEach(e=>{e.forwardEnd_date&&(!a||e.forwardEnd_date>a.forwardEnd_date)&&(a=e)}),!a)return n;let s=a;for(;s&&(n.add(s.taskId),s.dependency&&0!==s.dependency.length);){let e=null,n=l(s.forwardEnd_date,(parseInt(s.duration)||1)-1);s.dependency.forEach(a=>{let l=t.get(parseInt(a));l&&l.forwardEnd_date&&d(l.forwardEnd_date,1).getTime()===n.getTime()&&(!e||l.forwardEnd_date>e.forwardEnd_date)&&(e=l)}),s=e}return n}(r)}function o(e){let t=new Map,n=new Map;e.forEach(e=>{t.set(e.taskId,[]),n.set(e.taskId,0)}),e.forEach(e=>{(e.dependency||[]).forEach(a=>{let d=parseInt(a);t.has(d)&&(t.get(d).push(e.taskId),n.set(e.taskId,(n.get(e.taskId)||0)+1))})});let a=[];n.forEach((e,t)=>{0===e&&a.push(t)});let d=[];for(;a.length>0;){let e=a.shift();d.push(e),(t.get(e)||[]).forEach(e=>{n.set(e,n.get(e)-1),0===n.get(e)&&a.push(e)})}let l=d.length!==e.length,s=[];return l&&n.forEach((e,t)=>{e>0&&s.push(t)}),{sorted:d,hasCycle:l,cycleNodes:s}}function c(e){if(!e.target.classList.contains("gantt-resizer"))return;e.preventDefault();let t=e.target.closest(".gantt-container"),n=t.querySelector(".gantt-tasks"),a=e.clientX,d=n.offsetWidth,l=e=>{let n=d+(e.clientX-a);n>150&&n<800&&(t.style.gridTemplateColumns=`${n}px 5px 1fr`)},s=()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",s),k.config.ganttSettings.taskColumnWidth=n.offsetWidth,w(g)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",s)}let p=null;function u(e="all"){let t=document.getElementById("dashboard-metrics");if(!t)return;let a=function(e){if("all"===e)return k.teams.flatMap(e=>e.tasks);let t=k.teams.find(t=>t.id===e);return t?t.tasks:[]}(e);if(0===a.length){t.innerHTML='<p class="col-span-full text-center text-gray-500">Keine Daten für das Dashboard verfügbar.</p>',p&&(p.destroy(),p=null);return}let{endDate:d,totalDelay:l,completionPercentage:s,statusCounts:i}=function(e){let t=null,n=0,a=0,d={Completed:0,Blocked:0,"Not Started":0};e.forEach(e=>{e.forwardEnd_date&&(!t||e.forwardEnd_date>t)&&(t=e.forwardEnd_date),e.delay>n&&(n=e.delay),"Completed"===e.status&&a++,void 0!==d[e.status]?d[e.status]++:d["Not Started"]++});let l=e.length>0?Math.round(a/e.length*100):0;return{endDate:t,totalDelay:n,completionPercentage:l,statusCounts:d}}(a);t.innerHTML=`
        <div class="kpi-card">
            <span class="kpi-title">Projekt-Enddatum</span>
            <span class="kpi-value">${n(d)}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Maximaler Verzug (Tage)</span>
            <span class="kpi-value ${l>0?"text-red-600":"text-gray-800"}">${l}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Abgeschlossen</span>
            <span class="kpi-value text-green-600">${s}%</span>
        </div>
        <div class="kpi-card kpi-chart-container">
            <canvas id="status-chart"></canvas>
        </div>
    `,function(e){let t=document.getElementById("status-chart")?.getContext("2d");t&&(p&&(p.destroy(),p=null),p=new Chart(t,{type:"doughnut",data:{labels:["Abgeschlossen","Blockiert","Nicht begonnen"],datasets:[{data:[e.Completed,e.Blocked,e["Not Started"]],backgroundColor:["#10B981","#F59E0B","#6B7280"],borderColor:"#ffffff",borderWidth:2,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:"Aufgaben nach Status"}}}}))}(i)}function m(){let{config:a,teams:d}=k;document.getElementById("main-title").textContent=a.title,document.getElementById("main-subtitle").textContent=a.subtitle;let s=document.getElementById("project-teams"),i=window.scrollY,r={};document.querySelectorAll(".gantt-wrapper:not(.hidden)").forEach(e=>{r[e.closest(".team-section").dataset.teamId]=!0}),s.innerHTML="";let o=document.getElementById("initial-prompt");0===d.length?(o&&(o.style.display="block"),document.getElementById("dashboard-container").classList.add("hidden"),g()):(o&&(o.style.display="none"),document.getElementById("dashboard-container").classList.remove("hidden"),function(){let e=document.getElementById("dashboard-team-filter");if(!e)return;let t=e.value;e.innerHTML='<option value="all">Gesamtes Projekt</option>',k.teams.forEach(t=>{let n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}),k.teams.some(e=>e.id===t)?e.value=t:e.value="all"}(),u(document.getElementById("dashboard-team-filter").value),d.forEach(a=>{let d=function(a){let d=document.createElement("div");d.id=a.id,d.className="team-section bg-white shadow-lg rounded-lg p-6",d.dataset.teamId=a.id;let s=["w-20","w-24","w-28","w-32","w-36","w-40","w-48","w-56","w-64","w-72","w-80","w-96"],i=k.config.columns.filter(e=>"forward"===a.planningMode?"plannedEnd"!==e.key||e.type.startsWith("display"):"backward"!==a.planningMode||"plannedStart"!==e.key),r=i.map(e=>{let t=s.map(t=>`<option value="${t}" ${e.width===t?"selected":""}>${t.replace("w-","")}</option>`).join("");return`<th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${e.width||""}" data-key="${e.key}">
                    <div class="flex flex-col space-y-1">
                        <span>${e.label}</span>
                        <select data-column-key="${e.key}" class="column-width-select text-black font-normal normal-case p-1 text-xs rounded border bg-gray-100 hover:bg-gray-200">${t}</select>
                    </div>
                </th>`}).join(""),o=k.config.ganttSettings?.dayWidth||30;return d.innerHTML=`
        <div class="team-header flex justify-between items-start mb-4 gap-4 flex-wrap">
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-2 cursor-pointer toggle-collapse-btn">
                    <svg class="w-6 h-6 text-gray-600 transition-transform ${a.isCollapsed?"-rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <h2 contenteditable="true" class="team-name text-2xl font-bold text-gray-700 p-2">${a.name}</h2>
                </div>
                <!-- --- NEU: Dropdown f\xfcr den Planungsmodus --- -->
                <div class="planning-mode-selector ml-4">
                    <label for="planning-mode-${a.id}" class="text-sm font-medium text-gray-700 mr-2">Planungsmodus:</label>
                    <select id="planning-mode-${a.id}" class="planning-mode-select p-2 border rounded-md bg-gray-50">
                        <option value="backward" ${"backward"===a.planningMode?"selected":""}>Backward</option>
                        <option value="forward" ${"forward"===a.planningMode?"selected":""}>Forward</option>
                    </select>
                </div>
                <!-- --- NEU: Dropdown f\xfcr die Delay-Referenz --- -->
                <div class="delay-reference-selector ml-4">
                    <label for="delay-reference-${a.id}" class="text-sm font-medium text-gray-700 mr-2">Delay-Referenz:</label>
                    <select id="delay-reference-${a.id}" class="delay-reference-select p-2 border rounded-md bg-gray-50">
                        <option value="planned" ${"planned"===a.delayReference?"selected":""}>Planned</option>
                        <option value="baseline" ${"baseline"===a.delayReference?"selected":""}>Baseline</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 flex-wrap justify-end">
                <button class="action-btn duplicate-team-btn bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">Team duplizieren</button>
                <button class="action-btn set-team-baseline-btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">Baseline setzen</button>
                <button class="action-btn toggle-gantt-btn bg-cyan-600 text-white px-4 py-2 rounded-md hover:bg-cyan-700 transition">Gantt-Chart anzeigen</button>
                <button class="action-btn sort-tasks-btn bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition">Tasks sortieren</button>
                <button class="action-btn delete-team-btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Team l\xf6schen</button>
            </div>
        </div>
        <div class="team-content ${a.isCollapsed?"hidden":""}">
            <div class="gantt-controls hidden flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 p-3 bg-gray-50 rounded-md border">
                <label class="text-sm font-medium text-gray-700">Zoom:</label>
                <div class="flex items-center gap-2">
                    <button data-gantt-zoom="out" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">-</button>
                    <span class="text-sm font-semibold text-gray-700 w-16 text-center">${o}px/Tag</span>
                    <button data-gantt-zoom="in" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" class="critical-path-toggle" ${a.showCriticalPath?"checked":""}>
                    <label class="text-sm font-medium text-gray-700 select-none">Kritischer Pfad</label>
                </div>
                <div class="ml-auto">
                    <button class="action-btn screenshot-gantt-btn bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition text-sm">Gantt-Chart exportieren</button>
                </div>
            </div>
            <div class="gantt-wrapper hidden mb-6"></div>
            <div class="table-container">
                <table class="project-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>${r}<th></th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${a.tasks.map(e=>(function(e,a,d){let l=`${a.cycleError?"cycle-error":""}`,s=d.map(d=>{let l="",s=a[d.key]||"",i=a.dependency&&a.dependency.length>0;switch(d.type){case"text-input":l=`<input type="text" data-key="${d.key}" value="${s}" placeholder="${d.placeholder||""}">`;break;case"textarea":l=`<textarea data-key="${d.key}" rows="1" placeholder="${d.placeholder||""}">${s}</textarea>`;break;case"number-input":l=`<input type="number" data-key="${d.key}" value="${s||d.default}" min="${d.min||0}">`;break;case"date-input":let r=!1;("forward"===e.planningMode&&"plannedStart"===d.key&&i||"backward"===e.planningMode&&"plannedEnd"===d.key&&!a.isTerminal)&&(r=!0),l=r?`<span data-key="${d.key}">${n(t(a[d.key]))}</span>`:`<input type="date" data-key="${d.key}" value="${s}">`;break;case"select-dependency":let o=a.dependency||[],c=o.map(t=>e.tasks.find(e=>e.taskId==t)?`#${t}`:"").filter(Boolean).join(", "),p=e.tasks.filter(e=>e.taskId!==a.taskId).map(e=>`
                    <label class="dependency-option">
                        <input type="checkbox" class="dependency-checkbox" value="${e.taskId}" ${o.includes(String(e.taskId))?"checked":""}>
                        <span>#${e.taskId}: ${(e.taskName||"").substring(0,40)}</span>
                    </label>`).join("");l=`<div class="dependency-dropdown" data-key="dependency"><button type="button" class="dependency-dropdown-button w-full border rounded-md p-2 bg-white text-left truncate">${c||"Abhängigkeiten wählen..."}</button><div class="dependency-dropdown-panel">${p}</div></div>`;break;case"select-status":let u=d.options.map(e=>`<option value="${e}" ${s===e?"selected":""}>${e}</option>`).join("");l=`<select data-key="status">${u}</select>`;break;case"display":let m="forwardEnd"===d.key||"plannedEnd"===d.key?n(t(s)):s;l=`<span data-key="${d.key}" class="${d.isBold?"font-semibold":""}">${m}</span>`;break;case"display-delay":let g=null===a.delay?"-":a.delay,f="";"number"==typeof a.delay&&(f=a.delay<0?"delay-negative":a.delay>0?"delay-positive":"delay-on-time"),l=`<div data-key="${d.key}" class="delay text-center font-bold p-2 rounded-md ${f}">${g}</div>`}let y="";return"select-status"===d.type&&(y=({"Not Started":"status-not-started",Completed:"status-completed",Blocked:"status-blocked"})[a.status]||""),`<td class="${y}">${l}</td>`}).join("");return`<tr data-task-id="${a.taskId}" class="${l}">${s}<td><button class="delete-task-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td></tr>`})(a,e,i)).join("")}</tbody>
                </table>
            </div>
            <div class="mt-4"><button class="action-btn add-task-btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Task hinzuf\xfcgen +</button></div>
        </div>`,a.tasks.length>0&&d.querySelector(".gantt-wrapper").appendChild(function(t){let n=document.createElement("div");if(!t.tasks||0===t.tasks.length)return n;let a=t.tasks,d=k.config.ganttSettings?.dayWidth||30,s=k.config.ganttSettings?.taskColumnWidth||250,i=null,r=null;if(a.forEach(e=>{if(e.forwardEnd_date){let t=parseInt(e.duration)||1,n=l(e.forwardEnd_date,t>0?t-1:0);(!i||n<i)&&(i=n),(!r||e.forwardEnd_date>r)&&(r=e.forwardEnd_date)}if("baseline"===t.delayReference){if(e.baseline&&e.baseline.plannedEnd_date){let t=parseInt(e.baseline.duration)||1,n=l(e.baseline.plannedEnd_date,t>0?t-1:0);(!i||n<i)&&(i=n),(!r||e.baseline.plannedEnd_date>r)&&(r=e.baseline.plannedEnd_date)}}else if(e.plannedEnd_date){let t=parseInt(e.duration)||1,n=l(e.plannedEnd_date,t>0?t-1:0);(!i||n<i)&&(i=n),(!r||e.plannedEnd_date>r)&&(r=e.plannedEnd_date)}}),!i||!r)return n.innerHTML='<p class="text-center text-gray-500 p-4">Keine gültigen Daten für das Gantt-Diagramm vorhanden.</p>',n;let o=new Date(i);o.setUTCDate(o.getUTCDate()-5);let c=new Date(r);c.setUTCDate(c.getUTCDate()+5);let p="",u="",m="",g="",f=new Date(o),y=0,h=-1,b=0,w=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],v=d<25?"0.65rem":"0.75rem",E=d<25?"0.7rem":"0.8rem";for(;f<=c;){let t=f.getUTCDate(),n=f.getUTCMonth(),a=[0,6].includes(f.getUTCDay());n!==h&&(-1!==h&&(p+=`<div class="gantt-month" style="width: ${b*d}px; font-size: ${E};">${w[h]} ${f.getFullYear()}</div>`),h=n,b=0),b++,u+=`<div class="gantt-day ${a?"weekend":""}" style="width: ${d}px; font-size: ${v};">${t}</div>`,a&&(g+=`<div class="gantt-weekend-col" style="left: ${e(o,f)*d}px; width: ${d}px;"></div>`),f.setUTCDate(f.getUTCDate()+1),y++}p+=`<div class="gantt-month" style="width: ${b*d}px; font-size: ${E};">${w[h]} ${c.getFullYear()}</div>`;let x=y*d;a.forEach(()=>m+=`<div class="gantt-row" style="width: ${x}px"></div>`);let I=new Date;I.setUTCHours(0,0,0,0);let S=e(o,I)*d,$=I>=o&&I<=c?`<div class="gantt-today-marker" style="left: ${S}px;"></div>`:"",C=a.map((n,a)=>{let s="",i=37*a;if("baseline"===t.delayReference){if(n.baseline&&n.baseline.plannedEnd_date){let t=parseInt(n.baseline.duration)||1,a=l(n.baseline.plannedEnd_date,t>0?t-1:0),r=e(a,n.baseline.plannedEnd_date)+1,c=e(o,a)*d;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*d}px;" title="Baseline End: ${n.baseline.plannedEnd}"></div>`}}else if(n.plannedEnd_date){let t=parseInt(n.duration)||1,a=l(n.plannedEnd_date,t>0?t-1:0),r=e(a,n.plannedEnd_date)+1,c=e(o,a)*d;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*d}px;" title="Planned End: ${n.plannedEnd}"></div>`}if(n.forwardEnd_date){let a=parseInt(n.duration)||1,r=l(n.forwardEnd_date,a>0?a-1:0),c=e(r,n.forwardEnd_date)+1,p=e(o,r)*d,u="Completed"===n.status?"status-completed":"Blocked"===n.status?"status-blocked":"",m=!!t.showCriticalPath,g=t.criticalPath&&t.criticalPath.has(n.taskId),f=`#${n.taskId}: ${n.taskName||""}`;s+=`<div class="gantt-bar ${u} ${m?g?"is-critical":"dimmed":""}" style="top: ${i}px; left: ${p}px; width: ${c*d}px;" title="${f}">
                            <span><strong class="mr-1">#${n.taskId}</strong>${n.taskName||""}</span>
                       </div>`}return s}).join(""),_=a.map(e=>`<div class="gantt-task-name" title="${e.taskName}">#${e.taskId}: ${e.taskName||""}</div>`).join("");return n.className="gantt-container",n.style.gridTemplateColumns=`${s}px 5px 1fr`,n.innerHTML=`
        <div class="gantt-tasks"><div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div><div class="gantt-days"><div class="gantt-day">&nbsp;</div></div></div>${_}</div>
        <div class="gantt-resizer"></div>
        <div class="gantt-timeline">
            <div class="gantt-header-container" style="width: ${x}px">
                <div class="gantt-header">${p}</div>
                <div class="gantt-days">${u}</div>
            </div>
            <div class="gantt-rows" style="width: ${x}px">${g}${m}${C}</div>
            ${$}
        </div>`,n}(a)),d}(a);r[a.id]&&(d.querySelector(".gantt-wrapper").classList.remove("hidden"),d.querySelector(".gantt-controls").classList.remove("hidden"),d.querySelector(".toggle-gantt-btn").textContent="Gantt-Chart verbergen"),s.appendChild(d)})),window.scrollTo(0,i)}function g(e){let t=document.getElementById("save-status-text"),n=document.getElementById("save-status-warning");switch(e){case"saving":t.textContent="Speichern...",t.classList.remove("text-green-600"),n.classList.add("hidden");break;case"saved":t.textContent="✓ Alle Änderungen im Browser-Cache gespeichert",t.classList.add("text-green-600","font-medium"),n.classList.remove("hidden");break;default:t.textContent="",n.classList.add("hidden")}}function f(e){let t=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="none",t.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>t.classList.remove("visible")}function y(e,t,n=()=>{}){let a=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="block",a.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>{a.classList.remove("visible"),t()},document.getElementById("modal-cancel-btn").onclick=()=>{a.classList.remove("visible"),n()}}const h="projectPlannerState_v1";let b=null,k={config:{title:"Projektplaner",subtitle:"Lade deine Konfigurations- und Projektdateien, um zu beginnen.",ganttSettings:{dayWidth:30,taskColumnWidth:250},columns:[{key:"taskId",label:"ID",type:"display",width:"w-20"},{key:"taskName",label:"Task",type:"textarea",width:"w-80",placeholder:"Task name..."},{key:"responsible",label:"Responsible",type:"text-input",width:"w-40",placeholder:"Name..."},{key:"comment",label:"Comment",type:"textarea",width:"w-72",placeholder:"Note..."},{key:"dependency",label:"Dependency",type:"select-dependency",width:"w-56"},{key:"duration",label:"Duration (Days)",type:"number-input",width:"w-28",min:0,default:1},{key:"plannedStart",label:"Planned Start",type:"date-input",width:"w-40"},{key:"plannedEnd",label:"Planned End",type:"date-input",width:"w-40"},{key:"actualEnd",label:"Actual End",type:"date-input",width:"w-40"},{key:"forwardEnd",label:"New End",type:"display",width:"w-40",isBold:!0},{key:"delay",label:"Delay (Days)",type:"display-delay",width:"w-28",isBold:!0,isCentered:!0},{key:"status",label:"Status",type:"select-status",width:"w-40",options:["Not Started","Blocked","Completed"]}]},teams:[]};function w(e){clearTimeout(b),e&&e("saving"),b=setTimeout(()=>{try{let t=JSON.parse(JSON.stringify(k,(e,t)=>{if(!e.endsWith("_date"))return t}));localStorage.setItem(h,JSON.stringify(t)),e&&e("saved")}catch(t){console.error("Could not save state to localStorage",t),f("Fehler: Der Projektstatus konnte nicht lokal gespeichert werden."),e&&e("error")}},500)}function v(e,t,n,a){let d=k.teams.find(t=>t.id===e);if(!d)return;let l=d.tasks.find(e=>e.taskId===t);l&&(l[n]=a)}let E=null,x=!1;function I(){return x}function S(){x=!0,w(g)}function $(){if(!k)return"{}";k.config.title=document.getElementById("main-title").textContent,k.config.subtitle=document.getElementById("main-subtitle").textContent;let e=document.querySelector(".gantt-wrapper:not(.hidden) .gantt-tasks");e&&e.offsetWidth>0&&(k.config.ganttSettings.taskColumnWidth=e.offsetWidth);let t=k.teams.map(e=>{let t=(e=>{let t=new Set;return e.forEach(e=>(e.dependency||[]).forEach(e=>t.add(parseInt(e)))),t})(e.tasks||[]),n=(e.tasks||[]).map(n=>{let a=!t.has(n.taskId),d=!n.dependency||0===n.dependency.length,l={taskId:n.taskId};return l.duration=n.duration,n.taskName&&(l.taskName=n.taskName),n.responsible&&(l.responsible=n.responsible),n.comment&&(l.comment=n.comment),n.dependency&&n.dependency.length>0&&(l.dependency=n.dependency),"backward"===e.planningMode?a&&n.plannedEnd&&(l.plannedEnd=n.plannedEnd):d&&n.plannedStart&&(l.plannedStart=n.plannedStart),n.actualEnd&&(l.actualEnd=n.actualEnd),"Blocked"===n.status&&(l.status="Blocked"),l}),a=(e.baselines||[]).map(e=>{let t={taskId:e.taskId};return e.plannedEnd&&(t.plannedEnd=e.plannedEnd),e.duration&&(t.duration=e.duration),t});return{id:e.id,name:e.name,planningMode:e.planningMode||"backward",delayReference:e.delayReference||"planned",isCollapsed:!!e.isCollapsed,lastTaskId:e.lastTaskId||e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0,tasks:n,baselines:a}});return JSON.stringify({config:k.config,teams:t},(e,t)=>{if(!("string"==typeof e&&e.endsWith("_date")))return t},2)}function C(e){let t=e.config||e?.appState?.config,n=e.teams||e?.appState?.teams;return t&&Array.isArray(t.columns)&&Array.isArray(n)?(t.ganttSettings={...k.config.ganttSettings,...t.ganttSettings},k.config=t,k.teams=n,k.teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned"),e.lastTaskId||(e.lastTaskId=e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0)}),k.teams.forEach(e=>r(e.id)),m(),w(null),f("Projektdatei erfolgreich geladen!"),!0):(f("Ungültige Projektdatei. Erwartet { config, teams }."),!1)}function _(){return window.isSecureContext&&"function"==typeof window.showOpenFilePicker&&"function"==typeof window.showSaveFilePicker}async function T(e,t){let n={mode:t?"readwrite":"read"};return await e.queryPermission(n)==="granted"||await e.requestPermission(n)==="granted"}async function L(e,t){let n=await e.createWritable();await n.write(t),await n.close()}async function D(){try{if(!_())return void document.getElementById("project-json-upload").click();let[e]=await window.showOpenFilePicker({types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1,multiple:!1});if(!e||!await T(e,!1))return;let t=await e.getFile(),n=await t.text(),a=JSON.parse(n);C(a)&&(E=e,x=!1)}catch(e){e?.name!=="AbortError"&&(console.error("Open via picker failed:",e),f("Datei konnte nicht geöffnet werden."))}}async function B(){try{let e=$();if(E&&_()&&await T(E,!0)){await L(E,e),x=!1,f("Projektdatei gespeichert (Schnell speichern).");return}await M(e)}catch(e){console.error("Quick save failed:",e),f("Speichern fehlgeschlagen.")}}async function M(e=null){try{let t=e??$();if(_()){let e=(document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt")+".project.json",n=await window.showSaveFilePicker({suggestedName:e,types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1});if(!await T(n,!0))return;await L(n,t),E=n,x=!1,f("Projektdatei gespeichert.");return}let n=new Blob([t],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(n);let d=document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt";a.download=`${d}.project.json`,a.click(),URL.revokeObjectURL(a.href),x=!1,f("Projektdatei gespeichert.")}catch(e){e?.name!=="AbortError"&&(console.error("Save As failed:",e),f("Speichern fehlgeschlagen."))}}function j(e){let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=e=>{try{let t=JSON.parse(e.target.result);C(t)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),f("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}},n.readAsText(t)}function N(e){let t=e.target,{teamId:n,taskId:a}=i(t);if(!n)return;let d=k.teams.find(e=>e.id===n);if(!d)return;if(t.classList.contains("column-width-select"))return void function(e,t){let n=k.config.columns.find(t=>t.key===e);n&&(n.width=t),m(),S()}(t.dataset.columnKey,t.value);if(t.classList.contains("planning-mode-select")){d.planningMode=t.value,r(n),m(),S();return}if(t.classList.contains("delay-reference-select")){d.delayReference=t.value,r(n),m(),S();return}if(t.classList.contains("critical-path-toggle")){d.showCriticalPath=t.checked,m(),S();return}let l=!1;if(t.classList.contains("dependency-checkbox"))v(n,a,"dependency",Array.from(t.closest(".dependency-dropdown").querySelectorAll(".dependency-checkbox:checked")).map(e=>e.value)),l=!0;else{let e=t.dataset.key;if(v(n,a,e,t.value),["duration","plannedEnd","actualEnd","dependency","status","plannedStart"].includes(e)&&(l=!0),"status"===e){let e=d.tasks.find(e=>e.taskId===a);if(e)if("Completed"===t.value){let t=new Date,n=t.getUTCFullYear(),a=String(t.getUTCMonth()+1).padStart(2,"0"),d=String(t.getUTCDate()).padStart(2,"0");e.actualEnd=`${n}-${a}-${d}`}else e.actualEnd&&(e.actualEnd="")}if("actualEnd"===e){let e=d.tasks.find(e=>e.taskId===a);e&&(t.value?e.status="Completed":"Completed"===e.status&&(e.status="Not Started"))}}l&&r(n),m(),S()}function P(e){let t=e.target,{teamId:n,taskId:a}=i(t);if("main-title"===t.id||"main-subtitle"===t.id){k.config["main-title"===t.id?"title":"subtitle"]=t.textContent,S();return}if(n){if(t.classList.contains("team-name")){let e=k.teams.find(e=>e.id===n);e&&(e.name=t.textContent)}else{let e=t.dataset.key;"TEXTAREA"===t.tagName&&(t.style.height="auto",t.style.height=t.scrollHeight+"px"),v(n,a,e,t.value)}S()}}function A(e){let t=e.target,{teamId:n,taskId:a}=i(t);if(n){if(t.closest(".toggle-collapse-btn")&&!t.closest(".team-name")){let e=k.teams.find(e=>e.id===n);e&&(e.isCollapsed=!e.isCollapsed,S(),m());return}if(t.classList.contains("gantt-zoom-btn")){let e=t.dataset.ganttZoom,n=k.config.ganttSettings.dayWidth;n="in"===e?Math.min(60,n+2):Math.max(10,n-2),k.config.ganttSettings.dayWidth=n,m(),S();return}if(t.classList.contains("toggle-gantt-btn")){let e=document.getElementById(n),a=e.querySelector(".gantt-wrapper"),d=e.querySelector(".gantt-controls"),l=a.classList.toggle("hidden");d.classList.toggle("hidden",l),t.textContent=l?"Gantt-Chart anzeigen":"Gantt-Chart verbergen";return}if(t.classList.contains("dependency-dropdown-button")){let e=t.nextElementSibling,n=e.classList.contains("visible");if(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),!n){e.classList.add("visible");let n=t.closest(".team-section");n?.classList.add("team-section-active"),n?.querySelector(".team-content")?.classList.add("overflow-visible"),n?.querySelector(".table-container")?.classList.add("overflow-visible")}}else t.classList.contains("add-task-btn")?function(e){let t=k.teams.find(t=>t.id===e);if(!t)return;t.lastTaskId++;let n={taskId:t.lastTaskId,dependency:[]};k.config.columns.forEach(e=>{e.default&&(n[e.key]=e.default)}),t.tasks.push(n),r(e),m(),S()}(n):t.classList.contains("delete-task-btn")?y(`M\xf6chtest du Task ${a} wirklich l\xf6schen?`,()=>(function(e,t){let n=k.teams.find(t=>t.id===e);n&&(n.tasks=n.tasks.filter(e=>e.taskId!==t),n.tasks.forEach(e=>{e.dependency?.includes(String(t))&&(e.dependency=e.dependency.filter(e=>e!==String(t)))}),r(e),m(),S())})(n,a)):t.classList.contains("sort-tasks-btn")?function(e){let t=k.teams.find(t=>t.id===e);if(!t)return;let{sorted:n,hasCycle:a}=o(t.tasks);if(a)return f("Fehler: Ein zirkulärer Verweis wurde entdeckt. Bitte die Abhängigkeiten korrigieren.");t.tasks=n.map(e=>t.tasks.find(t=>t.taskId===e)),m(),S()}(n):t.classList.contains("set-team-baseline-btn")?function(e){let t=k.teams.find(t=>t.id===e);t&&y(`M\xf6chten Sie den aktuellen Status f\xfcr Team "${t.name}" als Baseline festlegen? Eine bestehende Baseline f\xfcr dieses Team wird \xfcberschrieben.`,()=>{t.baselines=JSON.parse(JSON.stringify(t.tasks)),r(t.id),m(),S(),f(`Baseline f\xfcr Team "${t.name}" wurde erfolgreich gesetzt!`)})}(n):t.classList.contains("screenshot-gantt-btn")?O(n,t):t.classList.contains("duplicate-team-btn")?function(e){let t=k.teams.find(t=>t.id===e);if(!t)return;let n=k.teams.map(e=>parseInt(e.id.replace("team",""))||0),a=(n.length>0?Math.max(...n):0)+1,d=`team${a}`,l=(t.tasks||[]).map(e=>(e=>{let{plannedStart_date:t,plannedEnd_date:n,actualEnd_date:a,forwardEnd_date:d,baseline:l,cycleError:s,isTerminal:i,...r}=e,o=(r.dependency||[]).map(e=>String(e));return{...r,dependency:o}})({...e})),s=JSON.parse(JSON.stringify(t.baselines||[])),i=l.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0),o={id:d,name:`${t.name} (Kopie)`,tasks:l,baselines:s,lastTaskId:i,isCollapsed:t.isCollapsed||!1,planningMode:t.planningMode||"backward",delayReference:t.delayReference||"planned",showCriticalPath:t.showCriticalPath||!1};k.teams.push(o),r(o.id),m(),S(),f(`Team "${t.name}" wurde dupliziert.`)}(n):t.classList.contains("delete-team-btn")&&function(e){let t=k.teams.find(t=>t.id===e);t&&y(`M\xf6chtest du das Team "${t.name}" wirklich l\xf6schen? Diese Aktion kann nicht r\xfcckg\xe4ngig gemacht werden.`,()=>{k.teams=k.teams.filter(t=>t.id!==e),m(),S(),f(`Team "${t.name}" wurde gel\xf6scht.`)})}(n)}}function U(){let e=k.teams.map(e=>parseInt(e.id.replace("team",""))||0),t=(e.length>0?Math.max(...e):0)+1;k.teams.push({id:`team${t}`,name:`Neues Team ${t}`,tasks:[],lastTaskId:0,baselines:[],isCollapsed:!1,planningMode:"backward",delayReference:"planned",showCriticalPath:!1}),m(),S()}async function O(e,t){let n=document.getElementById(e),a=n?.querySelector(".gantt-container"),d=k.teams.find(t=>t.id===e);if(!a||!d)return void f("Fehler: Das Gantt-Chart zum Exportieren wurde nicht gefunden.");let l=t.textContent;t.textContent="Exportiere...",t.disabled=!0;let s=a.querySelector(".gantt-timeline"),i=s.querySelector(".gantt-header-container").scrollWidth,r=a.querySelector(".gantt-tasks").offsetWidth,o=a.style.cssText,c=s.style.cssText;a.style.width=`${r+i+10}px`,a.style.gridTemplateColumns=`${r}px 5px ${i}px`,s.style.overflowX="visible";try{let e=await html2canvas(a,{useCORS:!0,scale:2,backgroundColor:"#ffffff",width:a.scrollWidth,height:a.scrollHeight,windowWidth:a.scrollWidth,windowHeight:a.scrollHeight}),t=document.createElement("a"),n=d.name.replace(/\s+/g,"_");t.download=`Gantt-Chart_${n}.png`,t.href=e.toDataURL("image/png"),t.click()}catch(e){console.error("Fehler beim Erstellen des Screenshots:",e),f("Ein unerwarteter Fehler ist beim Exportieren aufgetreten.")}finally{t.textContent=l,t.disabled=!1,a.style.cssText=o,s.style.cssText=c}}function q(){y("Möchten Sie wirklich alle lokal gespeicherten Daten löschen? Dies kann nicht rückgängig gemacht werden und die Seite wird neu geladen.",()=>{localStorage.removeItem("projectPlannerState_v1"),g(),f("Lokale Daten wurden gelöscht. Seite wird neu geladen."),setTimeout(()=>window.location.reload(),1500)})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("project-json-upload").addEventListener("change",j);let e=document.getElementById("open-project-btn");e&&e.addEventListener("click",D);let t=document.getElementById("quick-save-project-btn");t&&t.addEventListener("click",B);let n=document.getElementById("save-as-project-json-btn");n&&n.addEventListener("click",()=>M()),document.getElementById("add-team-btn").addEventListener("click",U),document.getElementById("clear-storage-btn").addEventListener("click",q),document.getElementById("dashboard-team-filter").addEventListener("change",e=>u(e.target.value));let a=document.getElementById("project-teams");a.addEventListener("change",N),a.addEventListener("input",P),a.addEventListener("click",A),a.addEventListener("mousedown",c),document.addEventListener("click",e=>{e.target.closest(".dependency-dropdown")||(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")))}),document.addEventListener("keydown",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("s"!==e.key.toLowerCase()||e.shiftKey?"s"===e.key.toLowerCase()&&e.shiftKey?(e.preventDefault(),M()):"o"===e.key.toLowerCase()&&(e.preventDefault(),D()):(e.preventDefault(),B()))}),window.addEventListener("dragover",e=>{e.preventDefault()}),window.addEventListener("drop",async e=>{e.preventDefault();let t=e.dataTransfer?.files?.[0];if(t&&t.name.toLowerCase().endsWith(".json"))try{var n=await t.text();try{let e=JSON.parse(n);C(e)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),f("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}}catch(e){console.error("Drop load failed",e)}}),window.addEventListener("beforeunload",e=>{try{I&&x&&(e.preventDefault(),e.returnValue="")}catch{}}),localStorage.getItem("projectPlannerState_v1")?y("Eine gespeicherte Sitzung wurde gefunden. Möchten Sie sie wiederherstellen?",()=>{!function(){try{let e=localStorage.getItem(h);if(e){let t=JSON.parse(e);return t.config.ganttSettings||(t.config.ganttSettings={dayWidth:30,taskColumnWidth:250}),(k=t).teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned")}),k.teams.forEach(e=>r(e.id)),!0}}catch(e){console.error("Could not load state from localStorage",e),localStorage.removeItem(h)}return!1}()?m():(m(),g("saved"))},()=>m()):m();let d=document.getElementById("copyright-text");if(d){let e=new Date().getFullYear();d.textContent=`Copyright \xa9 ${e} Daniel Gruner`}});