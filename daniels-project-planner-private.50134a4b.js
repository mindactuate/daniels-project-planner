const e=(e,t)=>Math.round((t-e)/864e5);function t(e){if(!e||"string"!=typeof e)return null;e.includes("T")||e.includes("Z")||(e+="T00:00:00Z");let t=new Date(e);return isNaN(t.getTime())?null:new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()))}function a(e){if(!e||!(e instanceof Date)||isNaN(e))return"–";let t=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCMonth()+1).padStart(2,"0"),n=e.getUTCFullYear();return`${t}.${a}.${n}`}function n(e){return!e||!(e instanceof Date)||isNaN(e)?"":e.toISOString().split("T")[0]}function l(e,t){if(!e)return null;let a=new Date(e.getTime());if(t<=0)return a;let n=0;for(;n<t;)a.setUTCDate(a.getUTCDate()+1),0!==a.getUTCDay()&&6!==a.getUTCDay()&&n++;return a}function d(e,t){if(!e)return null;let a=new Date(e.getTime());if(t<=0)return a;let n=0;for(;n<t;)a.setUTCDate(a.getUTCDate()-1),0!==a.getUTCDay()&&6!==a.getUTCDay()&&n++;return a}function s(e,t){if(!e||!t||e.getTime()===t.getTime())return 0;let a=0,n=new Date(Math.min(e,t)),l=new Date(Math.max(e,t)),d=new Date(n);for(;d<=l;)0!==d.getUTCDay()&&6!==d.getUTCDay()&&a++,d.setUTCDate(d.getUTCDate()+1);return a=Math.max(0,a-1),e>t?-a:a}const i=e=>{let t=e.closest("tr"),a=e.closest(".team-section");return{teamId:a?a.dataset.teamId:null,taskId:t?parseInt(t.dataset.taskId):null}};function r(e){let t=new Map,a=new Map;e.forEach(e=>{t.set(e.taskId,[]),a.set(e.taskId,0)}),e.forEach(e=>{(e.dependency||[]).forEach(n=>{let l=parseInt(n);t.has(l)&&a.has(e.taskId)&&(t.get(l).push(e.taskId),a.set(e.taskId,(a.get(e.taskId)||0)+1))})});let n=[];a.forEach((e,t)=>{0===e&&n.push(t)});let l=[];for(;n.length;){let e=n.shift();l.push(e),(t.get(e)||[]).forEach(e=>{a.set(e,(a.get(e)||0)-1),0===(a.get(e)||0)&&n.push(e)})}return l}function o(e){var a,i;let r=b.teams.find(t=>t.id===e);if(!r)return;let o=new Map(r.tasks.map(e=>[e.taskId,e])),c=new Map((r.baselines||[]).map(e=>[e.taskId,e])),p=null,u=null;r.tasks.forEach(e=>{e.cycleError=!1,e.plannedStart_date=t(e.plannedStart),e.plannedEnd_date=t(e.plannedEnd),e.actualEnd_date=t(e.actualEnd);let a=c.get(e.taskId);e.baseline=a?{...a,plannedEnd_date:t(a.plannedEnd)}:null;let n=parseInt(e.duration)||0,l=n>0?n-1:0;if(e.baseline&&e.baseline.plannedEnd_date){let t=d(e.baseline.plannedEnd_date,l);(!p||t<p)&&(p=t)}if(e.actualEnd_date){let t=d(e.actualEnd_date,l);(!u||t<u)&&(u=t)}});let g=0;p&&u&&u>p&&(g=s(p,u));let f=r.tasks.some(e=>!!e.actualEnd_date),m=new Set;r.tasks.forEach(e=>{(e.dependency||[]).forEach(e=>m.add(parseInt(e)))}),r.tasks.forEach(e=>e.isTerminal=!m.has(e.taskId));let{hasCycle:h,cycleNodes:y,sorted:v}=function(e){let t=new Map,a=new Map;e.forEach(e=>{t.set(e.taskId,[]),a.set(e.taskId,0)}),e.forEach(e=>{(e.dependency||[]).forEach(n=>{let l=parseInt(n);t.has(l)&&(t.get(l).push(e.taskId),a.set(e.taskId,(a.get(e.taskId)||0)+1))})});let n=[];a.forEach((e,t)=>{0===e&&n.push(t)});let l=[];for(;n.length>0;){let e=n.shift();l.push(e),(t.get(e)||[]).forEach(e=>{a.set(e,a.get(e)-1),0===a.get(e)&&n.push(e)})}let d=l.length!==e.length,s=[];return d&&a.forEach((e,t)=>{e>0&&s.push(t)}),{sorted:l,hasCycle:d,cycleNodes:s}}(r.tasks);if(h)return void y.forEach(e=>{o.has(e)&&(o.get(e).cycleError=!0)});"forward"===r.planningMode?(a=o,v.forEach(e=>{let t=a.get(e),n=parseInt(t.duration)||0,d=t.plannedStart_date||null,s=null;t.dependency&&t.dependency.length>0&&t.dependency.forEach(e=>{let t=a.get(parseInt(e));if(t){let e=t.plannedEnd_date;e&&(!s||e>s)&&(s=e)}});let i=s?l(s,1):null,r=null;t.plannedStart_date=r=i&&d?i>d?i:d:i||d||null,r?t.plannedEnd_date=l(r,n>0?n-1:0):t.plannedEnd_date=null}),function(e,t,a,n){let d=new Map;a.forEach(e=>{let a,s=t.get(e),i=parseInt(s.duration)||0;if(s.actualEnd_date)a=s.actualEnd_date;else{let e=null,t=!0;if(s.dependency&&s.dependency.length>0){let a=null;s.dependency.forEach(e=>{let t=parseInt(e),n=d.get(t);n&&(!a||n>a)&&(a=n)}),a&&(e=l(a,1),t=!1)}if(e||(e=s.plannedStart_date),e){let d=t?l(e,n):e;a=l(d,i>0?i-1:0)}else a=null}d.set(e,a)}),t.forEach(e=>{let t=d.get(e.taskId),a=e.plannedEnd_date;t?e.forwardEnd_date=t:a?e.forwardEnd_date=a:e.forwardEnd_date=null})}(0,o,v,g)):(function(e,t){let a=new Map;e.forEach(e=>a.set(e.taskId,[])),e.forEach(e=>{(e.dependency||[]).forEach(t=>{let n=parseInt(t);a.has(n)&&a.get(n).push(e.taskId)})});for(let n=t.length-1;n>=0;n--){let l,s=t[n],i=e.get(s),r=parseInt(i.duration)||0,o=r>0?r-1:0;if(i.isTerminal)l=i.plannedEnd_date;else{let t=a.get(s),n=null;t&&t.length>0&&t.forEach(t=>{let a=e.get(t);a&&a.plannedStart_date&&(null===n||a.plannedStart_date<n)&&(n=a.plannedStart_date)}),l=n?d(n,1):null}i.plannedEnd_date=l,i.plannedEnd_date?i.plannedStart_date=d(i.plannedEnd_date,o):i.plannedStart_date=null}}(o,v),function(e,t,a,n){let d=new Map;t.forEach(t=>{let a=e.get(t),n=parseInt(a.duration)||0;if(a.actualEnd_date)return void d.set(t,a.actualEnd_date);let s=null;a.dependency&&a.dependency.length>0&&a.dependency.forEach(t=>{let a=parseInt(t),n=e.get(a),l=d.get(a)||(n?n.plannedEnd_date:null);l&&(!s||l>s)&&(s=l)});let i=null;if(s){let e=l(s,1);i=e?l(e,n>0?n-1:0):null}else i=a.plannedEnd_date||null;let r=a.plannedEnd_date?i&&i>a.plannedEnd_date?i:a.plannedEnd_date:i;d.set(t,r)}),e.forEach(e=>{e.forwardEnd_date=d.get(e.taskId)||null})}(o,v,0,0)),i=r,o.forEach(e=>{let t="baseline"===i.delayReference&&e.baseline?e.baseline.plannedEnd_date:e.plannedEnd_date;t&&e.forwardEnd_date?e.delay=s(t,e.forwardEnd_date):e.delay=null,"Blocked"!==e.status&&(e.status=e.actualEnd_date?"Completed":"Not Started"),e.plannedStart=n(e.plannedStart_date),e.plannedEnd=n(e.plannedEnd_date),e.forwardEnd=n(e.forwardEnd_date)}),r.criticalPath=function(e){let t=new Map(e.tasks.map(e=>[e.taskId,e])),a=new Set;if(0===e.tasks.length)return a;let n=null;if(e.tasks.forEach(e=>{e.forwardEnd_date&&(!n||e.forwardEnd_date>n.forwardEnd_date)&&(n=e)}),!n)return a;let s=n;for(;s&&(a.add(s.taskId),s.dependency&&0!==s.dependency.length);){let e=null,a=d(s.forwardEnd_date,(parseInt(s.duration)||1)-1);s.dependency.forEach(n=>{let d=t.get(parseInt(n));d&&d.forwardEnd_date&&l(d.forwardEnd_date,1).getTime()===a.getTime()&&(!e||d.forwardEnd_date>e.forwardEnd_date)&&(e=d)}),s=e}return a}(r)}function c(e){if(!e.target.classList.contains("gantt-resizer"))return;e.preventDefault();let t=e.target.closest(".gantt-container"),a=t.querySelector(".gantt-tasks"),n=e.clientX,l=a.offsetWidth,d=e=>{let a=l+(e.clientX-n);a>150&&a<800&&(t.style.gridTemplateColumns=`${a}px 5px 1fr`)},s=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s),b.config.ganttSettings.taskColumnWidth=a.offsetWidth,k(f)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)}let p=null;function u(e="all"){let t=document.getElementById("dashboard-metrics");if(!t)return;let n=function(e){if("all"===e)return b.teams.flatMap(e=>e.tasks);let t=b.teams.find(t=>t.id===e);return t?t.tasks:[]}(e);if(0===n.length){t.innerHTML='<p class="col-span-full text-center text-gray-500">Keine Daten für das Dashboard verfügbar.</p>',p&&(p.destroy(),p=null);return}let{endDate:l,totalDelay:d,completionPercentage:s,statusCounts:i}=function(e){let t=null,a=0,n=0,l={Completed:0,Blocked:0,"Not Started":0};e.forEach(e=>{e.forwardEnd_date&&(!t||e.forwardEnd_date>t)&&(t=e.forwardEnd_date),e.delay>a&&(a=e.delay),"Completed"===e.status&&n++,void 0!==l[e.status]?l[e.status]++:l["Not Started"]++});let d=e.length>0?Math.round(n/e.length*100):0;return{endDate:t,totalDelay:a,completionPercentage:d,statusCounts:l}}(n);t.innerHTML=`
        <div class="kpi-card">
            <span class="kpi-title">Projekt-Enddatum</span>
            <span class="kpi-value">${a(l)}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Maximaler Verzug (Tage)</span>
            <span class="kpi-value ${d>0?"text-red-600":"text-gray-800"}">${d}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Abgeschlossen</span>
            <span class="kpi-value text-green-600">${s}%</span>
        </div>
        <div class="kpi-card kpi-chart-container">
            <canvas id="status-chart"></canvas>
        </div>
    `,function(e){let t=document.getElementById("status-chart")?.getContext("2d");t&&(p&&(p.destroy(),p=null),p=new Chart(t,{type:"doughnut",data:{labels:["Abgeschlossen","Blockiert","Nicht begonnen"],datasets:[{data:[e.Completed,e.Blocked,e["Not Started"]],backgroundColor:["#10B981","#F59E0B","#6B7280"],borderColor:"#ffffff",borderWidth:2,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:"Aufgaben nach Status"}}}}))}(i)}function g(){let{config:n,teams:l}=b;document.getElementById("main-title").textContent=n.title,document.getElementById("main-subtitle").textContent=n.subtitle;let s=document.getElementById("project-teams"),i=window.scrollY,o={};document.querySelectorAll(".gantt-wrapper:not(.hidden)").forEach(e=>{o[e.closest(".team-section").dataset.teamId]=!0}),s.innerHTML="";let c=document.getElementById("initial-prompt");0===l.length?(c&&(c.style.display="block"),document.getElementById("dashboard-container").classList.add("hidden"),f()):(c&&(c.style.display="none"),document.getElementById("dashboard-container").classList.remove("hidden"),function(){let e=document.getElementById("dashboard-team-filter");if(!e)return;let t=e.value;e.innerHTML='<option value="all">Gesamtes Projekt</option>',b.teams.forEach(t=>{let a=document.createElement("option");a.value=t.id,a.textContent=t.name,e.appendChild(a)}),b.teams.some(e=>e.id===t)?e.value=t:e.value="all"}(),u(document.getElementById("dashboard-team-filter").value),l.forEach(n=>{let l=function(n){let l=document.createElement("div");l.id=n.id,l.className="team-section bg-white shadow-lg rounded-lg p-6",l.dataset.teamId=n.id;let s=["w-20","w-24","w-28","w-32","w-36","w-40","w-48","w-56","w-64","w-72","w-80","w-96"],i=b.config.columns.filter(e=>"forward"===n.planningMode?"plannedEnd"!==e.key||e.type.startsWith("display"):"backward"!==n.planningMode||"plannedStart"!==e.key),o=i.map(e=>{let t=s.map(t=>`<option value="${t}" ${e.width===t?"selected":""}>${t.replace("w-","")}</option>`).join("");return`<th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${e.width||""}" data-key="${e.key}">
                    <div class="flex flex-col space-y-1">
                        <span>${e.label}</span>
                        <select data-column-key="${e.key}" class="column-width-select text-black font-normal normal-case p-1 text-xs rounded border bg-gray-100 hover:bg-gray-200">${t}</select>
                    </div>
                </th>`}).join(""),c=b.config.ganttSettings?.dayWidth||30,p=n.axisMode||"days",u=function(e){let t=e.sortMode||"topological",a=e.tasks||[];if(0===a.length)return[];let n=new Map(a.map(e=>[e.taskId,e]));if("topological"===t)return r(a).map(e=>n.get(e)).filter(Boolean);if("chains"===t)return(function(e){let t=e.tasks||[],a=new Map(t.map(e=>[e.taskId,e])),n=new Map,l=new Map;t.forEach(t=>{let d=(t.dependency||[]).map(e=>parseInt(e)).filter(e=>a.has(e));if(0===d.length)return void n.set(t.taskId,null);let s=null;if(e.criticalPath&&e.criticalPath.has(t.taskId)&&d.forEach(t=>{e.criticalPath.has(t)&&(s=t)}),null===s){let e=e=>{let t=a.get(e);return(t.forwardEnd_date||t.plannedEnd_date||new Date(0)).getTime()};d.sort((t,a)=>e(a)-e(t)),s=d[0]||null}n.set(t.taskId,s),null!==s&&(l.has(s)||l.set(s,[]),l.get(s).push(t.taskId))});let d=t.filter(e=>null===n.get(e.taskId)).map(e=>e.taskId),s=new Set,i=[],r=[...d];for(;r.length>0;){let e=r.shift();s.has(e)||function(e){let t=e,a=[];for(;null!=t&&!s.has(t);){s.add(t),a.push(t);let e=(l.get(t)||[]).filter(e=>!s.has(e));if(0===e.length)break;for(let t=1;t<e.length;t++)r.push(e[t]);t=e[0]}a.length>0&&i.push(a)}(e)}t.forEach(e=>{s.has(e.taskId)||i.push([e.taskId])});let o=t=>({hasCritical:!!e.criticalPath&&t.some(t=>e.criticalPath.has(t)),maxEnd:Math.max(...t.map(e=>{let t=a.get(e);return(t.forwardEnd_date||t.plannedEnd_date||new Date(0)).getTime()}))});return i.sort((e,t)=>{let a=o(e),n=o(t);return a.hasCritical!==n.hasCritical?a.hasCritical?-1:1:a.maxEnd-n.maxEnd}),i})(e).flat().map(e=>n.get(e)).filter(Boolean);if("critical"===t){let t=r(a),l=[],d=[];for(let a of t)e.criticalPath&&e.criticalPath.has(a)?l.push(a):d.push(a);return[...l,...d].map(e=>n.get(e)).filter(Boolean)}if("forwardEnd"===t||"plannedEnd"===t){let e="forwardEnd"===t?"forwardEnd_date":"plannedEnd_date";return[...a].sort((t,a)=>(t[e]?t[e].getTime():0)-(a[e]?a[e].getTime():0))}if("status"===t){let e={Blocked:0,"Not Started":1,Completed:2};return[...a].sort((t,a)=>(e[t.status]??99)-(e[a.status]??99))}return[...a].sort((e,t)=>e.taskId-t.taskId)}(n);return l.innerHTML=`
        <div class="team-header flex justify-between items-end mb-4 gap-4 flex-wrap">
            <div class="flex items-end gap-2">
                <div class="flex items-center gap-2 cursor-pointer toggle-collapse-btn">
                    <svg class="w-6 h-6 text-gray-600 transition-transform ${n.isCollapsed?"-rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <h2 contenteditable="true" class="team-name text-2xl font-bold text-gray-700 p-2">${n.name}</h2>
                </div>
                <!-- --- NEU: Dropdown f\xfcr den Planungsmodus --- -->
                <div class="planning-mode-selector ml-4 flex flex-col items-start">
                    <label for="planning-mode-${n.id}" class="text-xs font-medium text-gray-700 mb-1">Planungsmodus</label>
                    <select id="planning-mode-${n.id}" class="planning-mode-select p-2 border rounded-md bg-gray-50">
                        <option value="backward" ${"backward"===n.planningMode?"selected":""}>Backward</option>
                        <option value="forward" ${"forward"===n.planningMode?"selected":""}>Forward</option>
                    </select>
                </div>
                <!-- --- NEU: Dropdown f\xfcr die Delay-Referenz --- -->
                <div class="delay-reference-selector ml-4 flex flex-col items-start">
                    <label for="delay-reference-${n.id}" class="text-xs font-medium text-gray-700 mb-1">Delay-Referenz</label>
                    <select id="delay-reference-${n.id}" class="delay-reference-select p-2 border rounded-md bg-gray-50">
                        <option value="planned" ${"planned"===n.delayReference?"selected":""}>Planned</option>
                        <option value="baseline" ${"baseline"===n.delayReference?"selected":""}>Baseline</option>
                    </select>
                </div>
                <!-- --- NEU: Dropdown f\xfcr Sortierung --- -->
                <div class="sort-mode-selector ml-4 flex flex-col items-start">
                    <label class="text-xs font-medium text-gray-700 mb-1">Sort:</label>
                    <select class="sort-mode-select p-2 border rounded-md bg-gray-50">
                        <option value="topological" ${"topological"===(n.sortMode||"topological")?"selected":""}>Dependencies</option>
                        <option value="chains" ${"chains"===n.sortMode?"selected":""}>Chains</option>
                        <option value="critical" ${"critical"===n.sortMode?"selected":""}>Critical First</option>
                        <option value="forwardEnd" ${"forwardEnd"===n.sortMode?"selected":""}>New End</option>
                        <option value="plannedEnd" ${"plannedEnd"===n.sortMode?"selected":""}>Planned End</option>
                        <option value="status" ${"status"===n.sortMode?"selected":""}>Status</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 flex-wrap justify-end items-center">
                <button class="action-btn duplicate-team-btn bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">Team duplizieren</button>
                <button class="action-btn set-team-baseline-btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition ${n.isCollapsed?"hidden":""}">Baseline setzen</button>
                <button class="action-btn toggle-gantt-btn bg-cyan-600 text-white px-4 py-2 rounded-md hover:bg-cyan-700 transition ${n.isCollapsed?"hidden":""}">Gantt-Chart anzeigen</button>
                <button class="action-btn delete-team-btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Team l\xf6schen</button>
            </div>
        </div>
        <div class="team-content ${n.isCollapsed?"hidden":""}">
            <div class="gantt-controls hidden flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 p-3 bg-gray-50 rounded-md border">
                <label class="text-sm font-medium text-gray-700">Zoom:</label>
                <div class="flex items-center gap-2">
                    <button data-gantt-zoom="out" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">-</button>
                    <span class="text-sm font-semibold text-gray-700 w-16 text-center">${c}px/Tag</span>
                    <button data-gantt-zoom="in" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" class="critical-path-toggle" ${n.showCriticalPath?"checked":""}>
                    <label class="text-sm font-medium text-gray-700 select-none">Kritischer Pfad</label>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Achse:</label>
                    <select class="gantt-axis-select p-2 border rounded-md bg-gray-50">
                        <option value="days" ${"days"===p?"selected":""}>Tage</option>
                        <option value="weeks" ${"weeks"===p?"selected":""}>Wochen (KW)</option>
                        <option value="months" ${"months"===p?"selected":""}>Monate</option>
                        <option value="quarters" ${"quarters"===p?"selected":""}>Quartale</option>
                    </select>
                </div>
                <div class="ml-auto">
                    <button class="action-btn screenshot-gantt-btn bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition text-sm">Gantt-Chart exportieren</button>
                </div>
            </div>
            <div class="gantt-wrapper hidden mb-6"></div>
            <div class="table-container">
                <table class="project-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>${o}<th></th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${u.map(e=>(function(e,n,l){let d=`${n.cycleError?"cycle-error":""}`,s=l.map(l=>{let d="",s=n[l.key]||"",i=n.dependency&&n.dependency.length>0;switch(l.type){case"text-input":d=`<input type="text" data-key="${l.key}" value="${s}" placeholder="${l.placeholder||""}">`;break;case"textarea":d=`<textarea data-key="${l.key}" rows="1" placeholder="${l.placeholder||""}">${s}</textarea>`;break;case"number-input":d=`<input type="number" data-key="${l.key}" value="${s||l.default}" min="${l.min||0}">`;break;case"date-input":let r=!1;("forward"===e.planningMode&&"plannedStart"===l.key&&i||"backward"===e.planningMode&&"plannedEnd"===l.key&&!n.isTerminal)&&(r=!0),d=r?`<span data-key="${l.key}">${a(t(n[l.key]))}</span>`:`<input type="date" data-key="${l.key}" value="${s}">`;break;case"select-dependency":let o=n.dependency||[],c=o.map(t=>e.tasks.find(e=>e.taskId==t)?`#${t}`:"").filter(Boolean).join(", "),p=e.tasks.filter(e=>e.taskId!==n.taskId).map(e=>`
                    <label class="dependency-option">
                        <input type="checkbox" class="dependency-checkbox" value="${e.taskId}" ${o.includes(String(e.taskId))?"checked":""}>
                        <span>#${e.taskId}: ${(e.taskName||"").substring(0,40)}</span>
                    </label>`).join("");d=`<div class="dependency-dropdown" data-key="dependency"><button type="button" class="dependency-dropdown-button w-full border rounded-md p-2 bg-white text-left truncate">${c||"Abhängigkeiten wählen..."}</button><div class="dependency-dropdown-panel">${p}</div></div>`;break;case"select-status":let u=l.options.map(e=>`<option value="${e}" ${s===e?"selected":""}>${e}</option>`).join("");d=`<select data-key="status">${u}</select>`;break;case"display":let g="forwardEnd"===l.key||"plannedEnd"===l.key?a(t(s)):s;d=`<span data-key="${l.key}" class="${l.isBold?"font-semibold":""}">${g}</span>`;break;case"display-delay":let f=null===n.delay?"-":n.delay,m="";"number"==typeof n.delay&&(m=n.delay<0?"delay-negative":n.delay>0?"delay-positive":"delay-on-time"),d=`<div data-key="${l.key}" class="delay text-center font-bold p-2 rounded-md ${m}">${f}</div>`}let h="";return"select-status"===l.type&&(h=({"Not Started":"status-not-started",Completed:"status-completed",Blocked:"status-blocked"})[n.status]||""),`<td class="${h}">${d}</td>`}).join("");return`<tr data-task-id="${n.taskId}" class="${d}">${s}<td><button class="delete-task-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td></tr>`})(n,e,i)).join("")}</tbody>
                </table>
            </div>
            <div class="mt-4"><button class="action-btn add-task-btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Task hinzuf\xfcgen +</button></div>
        </div>`,n.tasks.length>0&&l.querySelector(".gantt-wrapper").appendChild(function(t){let a=document.createElement("div");if(!t.tasks||0===t.tasks.length)return a;let n=t.tasks,l=b.config.ganttSettings?.dayWidth||30,s=b.config.ganttSettings?.taskColumnWidth||250,i=null,r=null;if(n.forEach(e=>{if(e.forwardEnd_date){let t=parseInt(e.duration)||1,a=d(e.forwardEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.forwardEnd_date>r)&&(r=e.forwardEnd_date)}if("baseline"===t.delayReference){if(e.baseline&&e.baseline.plannedEnd_date){let t=parseInt(e.baseline.duration)||1,a=d(e.baseline.plannedEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.baseline.plannedEnd_date>r)&&(r=e.baseline.plannedEnd_date)}}else if(e.plannedEnd_date){let t=parseInt(e.duration)||1,a=d(e.plannedEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.plannedEnd_date>r)&&(r=e.plannedEnd_date)}}),!i||!r)return a.innerHTML='<p class="text-center text-gray-500 p-4">Keine gültigen Daten für das Gantt-Diagramm vorhanden.</p>',a;let o=new Date(i);o.setUTCDate(o.getUTCDate()-5);let c=new Date(r);c.setUTCDate(c.getUTCDate()+5);let p="",u="",g="",f="",m="",h="",y=new Date(o),v=0,k=-1,w=0,E=-1,x=-1,$=0,I=-1,C=-1,S=0,T=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],_=l<25?"0.65rem":"0.75rem",M=l<25?"0.7rem":"0.8rem";for(;y<=c;){let t=y.getUTCDate(),a=y.getUTCMonth(),n=y.getUTCFullYear(),d=[0,6].includes(y.getUTCDay()),s=Math.floor(a/3)+1;a!==k&&(-1!==k&&(u+=`<div class="gantt-month" style="width: ${w*l}px; font-size: ${M};">${T[k]} ${y.getFullYear()}</div>`),k=a,w=0),w++,(s!==I||n!==C)&&(-1!==I&&(p+=`<div class="gantt-quarter" style="width: ${S*l}px; font-size: ${M};">Q${I}/${String(C).slice(-2)}</div>`),I=s,C=n,S=0),S++;let{week:i,year:r}=function(e){let t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);let n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return{week:Math.ceil(((t-n)/864e5+1)/7),year:t.getUTCFullYear()}}(y);(i!==E||r!==x)&&(-1!==E&&(g+=`<div class="gantt-week" style="width: ${$*l}px; font-size: ${_};">KW ${E}</div>`),E=i,x=r,$=0),$++,f+=`<div class="gantt-day ${d?"weekend":""}" style="width: ${l}px; font-size: ${_};">${t}</div>`,d&&(h+=`<div class="gantt-weekend-col" style="left: ${e(o,y)*l}px; width: ${l}px;"></div>`),y.setUTCDate(y.getUTCDate()+1),v++}u+=`<div class="gantt-month" style="width: ${w*l}px; font-size: ${M};">${T[k]} ${c.getFullYear()}</div>`,S>0&&(p+=`<div class="gantt-quarter" style="width: ${S*l}px; font-size: ${M};">Q${I}/${String(C).slice(-2)}</div>`),$>0&&(g+=`<div class="gantt-week" style="width: ${$*l}px; font-size: ${_};">KW ${E}</div>`);let L=v*l,D=t.axisMode||"days",B="",j="";"days"===D?(B=`
                <div class="gantt-header">${u}</div>
                <div class="gantt-days">${f}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div><div class="gantt-days"><div class="gantt-day">&nbsp;</div></div></div>'):"weeks"===D?(B=`
                <div class="gantt-header">${u}</div>
                <div class="gantt-weeks">${g}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div><div class="gantt-weeks"><div class="gantt-week">&nbsp;</div></div></div>'):"months"===D?(B=`
                <div class="gantt-quarters">${p}</div>
                <div class="gantt-header">${u}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-quarters"><div class="gantt-quarter">&nbsp;</div></div><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div></div>'):"quarters"===D&&(B=`
                <div class="gantt-quarters">${p}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-quarters"><div class="gantt-quarter">&nbsp;</div></div></div>'),n.forEach(()=>m+=`<div class="gantt-row" style="width: ${L}px"></div>`);let N=new Date;N.setUTCHours(0,0,0,0);let P=e(o,N)*l,U=N>=o&&N<=c?`<div class="gantt-today-marker" style="left: ${P}px;"></div>`:"",A=n.map((a,n)=>{let s="",i=37*n;if("baseline"===t.delayReference){if(a.baseline&&a.baseline.plannedEnd_date){let t=parseInt(a.baseline.duration)||1,n=d(a.baseline.plannedEnd_date,t>0?t-1:0),r=e(n,a.baseline.plannedEnd_date)+1,c=e(o,n)*l;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*l}px;" title="Baseline End: ${a.baseline.plannedEnd}"></div>`}}else if(a.plannedEnd_date){let t=parseInt(a.duration)||1,n=d(a.plannedEnd_date,t>0?t-1:0),r=e(n,a.plannedEnd_date)+1,c=e(o,n)*l;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*l}px;" title="Planned End: ${a.plannedEnd}"></div>`}if(a.forwardEnd_date){let n=parseInt(a.duration)||1,r=d(a.forwardEnd_date,n>0?n-1:0),c=e(r,a.forwardEnd_date)+1,p=e(o,r)*l,u="Completed"===a.status?"status-completed":"Blocked"===a.status?"status-blocked":"",g=!!t.showCriticalPath,f=t.criticalPath&&t.criticalPath.has(a.taskId),m=`#${a.taskId}: ${a.taskName||""}`;s+=`<div class="gantt-bar ${u} ${g?f?"is-critical":"dimmed":""}" style="top: ${i}px; left: ${p}px; width: ${c*l}px;" title="${m}">
                            <span><strong class="mr-1">#${a.taskId}</strong>${a.taskName||""}</span>
                       </div>`}return s}).join(""),q=n.map(e=>`<div class="gantt-task-name" title="${e.taskName}">#${e.taskId}: ${e.taskName||""}</div>`).join("");return a.className="gantt-container",a.style.gridTemplateColumns=`${s}px 5px 1fr`,a.innerHTML=`
        <div class="gantt-tasks">${j}${q}</div>
        <div class="gantt-resizer"></div>
        <div class="gantt-timeline">
            <div class="gantt-header-container" style="width: ${L}px">
                ${B}
            </div>
            <div class="gantt-rows" style="width: ${L}px">${h}${m}${A}</div>
            ${U}
        </div>`,a}({...n,tasks:u})),l}(n);o[n.id]&&(l.querySelector(".gantt-wrapper").classList.remove("hidden"),l.querySelector(".gantt-controls").classList.remove("hidden"),l.querySelector(".toggle-gantt-btn").textContent="Gantt-Chart verbergen"),s.appendChild(l)})),window.scrollTo(0,i)}function f(e){let t=document.getElementById("save-status-text"),a=document.getElementById("save-status-warning");switch(e){case"saving":t.textContent="Speichern...",t.classList.remove("text-green-600"),a.classList.add("hidden");break;case"saved":t.textContent="✓ Alle Änderungen im Browser-Cache gespeichert",t.classList.add("text-green-600","font-medium"),a.classList.remove("hidden");break;default:t.textContent="",a.classList.add("hidden")}}function m(e){let t=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="none",t.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>t.classList.remove("visible")}function h(e,t,a=()=>{}){let n=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="block",n.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>{n.classList.remove("visible"),t()},document.getElementById("modal-cancel-btn").onclick=()=>{n.classList.remove("visible"),a()}}const y="projectPlannerState_v1";let v=null,b={config:{title:"Projektplaner",subtitle:"Lade deine Konfigurations- und Projektdateien, um zu beginnen.",ganttSettings:{dayWidth:30,taskColumnWidth:250,axisMode:"days"},columns:[{key:"taskId",label:"ID",type:"display",width:"w-20"},{key:"taskName",label:"Task",type:"textarea",width:"w-80",placeholder:"Task name..."},{key:"responsible",label:"Responsible",type:"text-input",width:"w-40",placeholder:"Name..."},{key:"comment",label:"Comment",type:"textarea",width:"w-72",placeholder:"Note..."},{key:"dependency",label:"Dependency",type:"select-dependency",width:"w-56"},{key:"duration",label:"Duration (Days)",type:"number-input",width:"w-28",min:0,default:1},{key:"plannedStart",label:"Planned Start",type:"date-input",width:"w-40"},{key:"plannedEnd",label:"Planned End",type:"date-input",width:"w-40"},{key:"actualEnd",label:"Actual End",type:"date-input",width:"w-40"},{key:"forwardEnd",label:"New End",type:"display",width:"w-40",isBold:!0},{key:"delay",label:"Delay (Days)",type:"display-delay",width:"w-28",isBold:!0,isCentered:!0},{key:"status",label:"Status",type:"select-status",width:"w-40",options:["Not Started","Blocked","Completed"]}]},teams:[]};function k(e){clearTimeout(v),e&&e("saving"),v=setTimeout(()=>{try{let t=JSON.parse(JSON.stringify(b,(e,t)=>{if(!e.endsWith("_date"))return t}));localStorage.setItem(y,JSON.stringify(t)),e&&e("saved")}catch(t){console.error("Could not save state to localStorage",t),m("Fehler: Der Projektstatus konnte nicht lokal gespeichert werden."),e&&e("error")}},500)}function w(e,t,a,n){let l=b.teams.find(t=>t.id===e);if(!l)return;let d=l.tasks.find(e=>e.taskId===t);d&&(d[a]=n)}let E=null,x=!1;function $(){return x}function I(){x=!0,k(f)}function C(){if(!b)return"{}";b.config.title=document.getElementById("main-title").textContent,b.config.subtitle=document.getElementById("main-subtitle").textContent;let e=document.querySelector(".gantt-wrapper:not(.hidden) .gantt-tasks");e&&e.offsetWidth>0&&(b.config.ganttSettings.taskColumnWidth=e.offsetWidth);let t=b.teams.map(e=>{let t=(e=>{let t=new Set;return e.forEach(e=>(e.dependency||[]).forEach(e=>t.add(parseInt(e)))),t})(e.tasks||[]),a=(e.tasks||[]).map(a=>{let n=!t.has(a.taskId),l=!a.dependency||0===a.dependency.length,d={taskId:a.taskId};return d.duration=a.duration,a.taskName&&(d.taskName=a.taskName),a.responsible&&(d.responsible=a.responsible),a.comment&&(d.comment=a.comment),a.dependency&&a.dependency.length>0&&(d.dependency=a.dependency),"backward"===e.planningMode?n&&a.plannedEnd&&(d.plannedEnd=a.plannedEnd):l&&a.plannedStart&&(d.plannedStart=a.plannedStart),a.actualEnd&&(d.actualEnd=a.actualEnd),"Blocked"===a.status&&(d.status="Blocked"),d}),n=(e.baselines||[]).map(e=>{let t={taskId:e.taskId};return e.plannedEnd&&(t.plannedEnd=e.plannedEnd),e.duration&&(t.duration=e.duration),t});return{id:e.id,name:e.name,planningMode:e.planningMode||"backward",delayReference:e.delayReference||"planned",isCollapsed:!!e.isCollapsed,lastTaskId:e.lastTaskId||e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0,tasks:a,baselines:n}});return JSON.stringify({config:b.config,teams:t},(e,t)=>{if(!("string"==typeof e&&e.endsWith("_date")))return t},2)}function S(e){let t=e.config||e?.appState?.config,a=e.teams||e?.appState?.teams;return t&&Array.isArray(t.columns)&&Array.isArray(a)?(t.ganttSettings={...b.config.ganttSettings,...t.ganttSettings},b.config=t,b.teams=a,b.teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned"),e.lastTaskId||(e.lastTaskId=e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0)}),b.teams.forEach(e=>o(e.id)),g(),k(null),m("Projektdatei erfolgreich geladen!"),!0):(m("Ungültige Projektdatei. Erwartet { config, teams }."),!1)}function T(){return window.isSecureContext&&"function"==typeof window.showOpenFilePicker&&"function"==typeof window.showSaveFilePicker}async function _(e,t){let a={mode:t?"readwrite":"read"};return await e.queryPermission(a)==="granted"||await e.requestPermission(a)==="granted"}async function M(e,t){let a=await e.createWritable();await a.write(t),await a.close()}async function L(){try{if(!T())return void document.getElementById("project-json-upload").click();let[e]=await window.showOpenFilePicker({types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1,multiple:!1});if(!e||!await _(e,!1))return;let t=await e.getFile(),a=await t.text(),n=JSON.parse(a);S(n)&&(E=e,x=!1)}catch(e){e?.name!=="AbortError"&&(console.error("Open via picker failed:",e),m("Datei konnte nicht geöffnet werden."))}}async function D(){try{let e=C();if(E&&T()&&await _(E,!0)){await M(E,e),x=!1,m("Projektdatei gespeichert (Schnell speichern).");return}await B(e)}catch(e){console.error("Quick save failed:",e),m("Speichern fehlgeschlagen.")}}async function B(e=null){try{let t=e??C();if(T()){let e=(document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt")+".project.json",a=await window.showSaveFilePicker({suggestedName:e,types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1});if(!await _(a,!0))return;await M(a,t),E=a,x=!1,m("Projektdatei gespeichert.");return}let a=new Blob([t],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(a);let l=document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt";n.download=`${l}.project.json`,n.click(),URL.revokeObjectURL(n.href),x=!1,m("Projektdatei gespeichert.")}catch(e){e?.name!=="AbortError"&&(console.error("Save As failed:",e),m("Speichern fehlgeschlagen."))}}function j(e){let t=e.target.files[0];if(!t)return;let a=new FileReader;a.onload=e=>{try{let t=JSON.parse(e.target.result);S(t)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),m("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}},a.readAsText(t)}function N(e){let t=e.target,{teamId:a,taskId:n}=i(t);if(!a)return;let l=b.teams.find(e=>e.id===a);if(!l)return;if(t.classList.contains("column-width-select"))return void function(e,t){let a=b.config.columns.find(t=>t.key===e);a&&(a.width=t),g(),I()}(t.dataset.columnKey,t.value);if(t.classList.contains("planning-mode-select")){l.planningMode=t.value,o(a),g(),I();return}if(t.classList.contains("delay-reference-select")){l.delayReference=t.value,o(a),g(),I();return}if(t.classList.contains("gantt-axis-select")){l.axisMode=t.value,g(),I();return}if(t.classList.contains("sort-mode-select")){l.sortMode=t.value,o(a),g(),I();return}if(t.classList.contains("critical-path-toggle")){l.showCriticalPath=t.checked,g(),I();return}let d=!1;if(t.classList.contains("dependency-checkbox"))w(a,n,"dependency",Array.from(t.closest(".dependency-dropdown").querySelectorAll(".dependency-checkbox:checked")).map(e=>e.value)),d=!0;else{let e=t.dataset.key;if(w(a,n,e,t.value),["duration","plannedEnd","actualEnd","dependency","status","plannedStart"].includes(e)&&(d=!0),"status"===e){let e=l.tasks.find(e=>e.taskId===n);if(e)if("Completed"===t.value){let t=new Date,a=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0"),l=String(t.getUTCDate()).padStart(2,"0");e.actualEnd=`${a}-${n}-${l}`}else e.actualEnd&&(e.actualEnd="")}if("actualEnd"===e){let e=l.tasks.find(e=>e.taskId===n);e&&(t.value?e.status="Completed":"Completed"===e.status&&(e.status="Not Started"))}}d&&o(a),g(),I()}function P(e){let t=e.target,{teamId:a,taskId:n}=i(t);if("main-title"===t.id||"main-subtitle"===t.id){b.config["main-title"===t.id?"title":"subtitle"]=t.textContent,I();return}if(a){if(t.classList.contains("team-name")){let e=b.teams.find(e=>e.id===a);e&&(e.name=t.textContent)}else{let e=t.dataset.key;"TEXTAREA"===t.tagName&&(t.style.height="auto",t.style.height=t.scrollHeight+"px"),w(a,n,e,t.value)}I()}}function U(e){let t=e.target,{teamId:a,taskId:n}=i(t);if(a){if(t.closest(".toggle-collapse-btn")&&!t.closest(".team-name")){let e=b.teams.find(e=>e.id===a);e&&(e.isCollapsed=!e.isCollapsed,I(),g());return}if(t.classList.contains("gantt-zoom-btn")){let e=t.dataset.ganttZoom,a=b.config.ganttSettings.dayWidth;a="in"===e?Math.min(60,a+2):Math.max(2,a-2),b.config.ganttSettings.dayWidth=a,g(),I();return}if(t.classList.contains("toggle-gantt-btn")){let e=document.getElementById(a),n=e.querySelector(".gantt-wrapper"),l=e.querySelector(".gantt-controls"),d=n.classList.toggle("hidden");l.classList.toggle("hidden",d),t.textContent=d?"Gantt-Chart anzeigen":"Gantt-Chart verbergen";return}if(t.classList.contains("dependency-dropdown-button")){let e=t.nextElementSibling,a=e.classList.contains("visible");if(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),!a){e.classList.add("visible");let a=t.closest(".team-section");a?.classList.add("team-section-active"),a?.querySelector(".team-content")?.classList.add("overflow-visible"),a?.querySelector(".table-container")?.classList.add("overflow-visible")}}else t.classList.contains("add-task-btn")?function(e){let t=b.teams.find(t=>t.id===e);if(!t)return;t.lastTaskId++;let a={taskId:t.lastTaskId,dependency:[]};b.config.columns.forEach(e=>{e.default&&(a[e.key]=e.default)}),t.tasks.push(a),o(e),g(),I()}(a):t.classList.contains("delete-task-btn")?h(`M\xf6chtest du Task ${n} wirklich l\xf6schen?`,()=>(function(e,t){let a=b.teams.find(t=>t.id===e);a&&(a.tasks=a.tasks.filter(e=>e.taskId!==t),a.tasks.forEach(e=>{e.dependency?.includes(String(t))&&(e.dependency=e.dependency.filter(e=>e!==String(t)))}),o(e),g(),I())})(a,n)):t.classList.contains("set-team-baseline-btn")?function(e){let t=b.teams.find(t=>t.id===e);t&&h(`M\xf6chten Sie den aktuellen Status f\xfcr Team "${t.name}" als Baseline festlegen? Eine bestehende Baseline f\xfcr dieses Team wird \xfcberschrieben.`,()=>{t.baselines=JSON.parse(JSON.stringify(t.tasks)),o(t.id),g(),I(),m(`Baseline f\xfcr Team "${t.name}" wurde erfolgreich gesetzt!`)})}(a):t.classList.contains("screenshot-gantt-btn")?q(a,t):t.classList.contains("duplicate-team-btn")?function(e){let t=b.teams.find(t=>t.id===e);if(!t)return;let a=b.teams.map(e=>parseInt(e.id.replace("team",""))||0),n=(a.length>0?Math.max(...a):0)+1,l=`team${n}`,d=(t.tasks||[]).map(e=>(e=>{let{plannedStart_date:t,plannedEnd_date:a,actualEnd_date:n,forwardEnd_date:l,baseline:d,cycleError:s,isTerminal:i,...r}=e,o=(r.dependency||[]).map(e=>String(e));return{...r,dependency:o}})({...e})),s=JSON.parse(JSON.stringify(t.baselines||[])),i=d.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0),r={id:l,name:`${t.name} (Kopie)`,tasks:d,baselines:s,lastTaskId:i,isCollapsed:t.isCollapsed||!1,planningMode:t.planningMode||"backward",delayReference:t.delayReference||"planned",showCriticalPath:t.showCriticalPath||!1,axisMode:t.axisMode||"days"};b.teams.push(r),o(r.id),g(),I(),m(`Team "${t.name}" wurde dupliziert.`)}(a):t.classList.contains("delete-team-btn")&&function(e){let t=b.teams.find(t=>t.id===e);t&&h(`M\xf6chtest du das Team "${t.name}" wirklich l\xf6schen? Diese Aktion kann nicht r\xfcckg\xe4ngig gemacht werden.`,()=>{b.teams=b.teams.filter(t=>t.id!==e),g(),I(),m(`Team "${t.name}" wurde gel\xf6scht.`)})}(a)}}function A(){let e=b.teams.map(e=>parseInt(e.id.replace("team",""))||0),t=(e.length>0?Math.max(...e):0)+1;b.teams.push({id:`team${t}`,name:`Neues Team ${t}`,tasks:[],lastTaskId:0,baselines:[],isCollapsed:!1,planningMode:"backward",delayReference:"planned",showCriticalPath:!1,axisMode:"days"}),g(),I()}async function q(e,t){let a=document.getElementById(e),n=a?.querySelector(".gantt-container"),l=b.teams.find(t=>t.id===e);if(!n||!l)return void m("Fehler: Das Gantt-Chart zum Exportieren wurde nicht gefunden.");let d=t.textContent;t.textContent="Exportiere...",t.disabled=!0;let s=n.querySelector(".gantt-timeline"),i=s.querySelector(".gantt-header-container").scrollWidth,r=n.querySelector(".gantt-tasks").offsetWidth,o=n.style.cssText,c=s.style.cssText;n.style.width=`${r+i+10}px`,n.style.gridTemplateColumns=`${r}px 5px ${i}px`,s.style.overflowX="visible";try{let e=await html2canvas(n,{useCORS:!0,scale:2,backgroundColor:"#ffffff",width:n.scrollWidth,height:n.scrollHeight,windowWidth:n.scrollWidth,windowHeight:n.scrollHeight}),t=document.createElement("a"),a=l.name.replace(/\s+/g,"_");t.download=`Gantt-Chart_${a}.png`,t.href=e.toDataURL("image/png"),t.click()}catch(e){console.error("Fehler beim Erstellen des Screenshots:",e),m("Ein unerwarteter Fehler ist beim Exportieren aufgetreten.")}finally{t.textContent=d,t.disabled=!1,n.style.cssText=o,s.style.cssText=c}}function W(){h("Möchten Sie wirklich alle lokal gespeicherten Daten löschen? Dies kann nicht rückgängig gemacht werden und die Seite wird neu geladen.",()=>{localStorage.removeItem("projectPlannerState_v1"),f(),m("Lokale Daten wurden gelöscht. Seite wird neu geladen."),setTimeout(()=>window.location.reload(),1500)})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("project-json-upload").addEventListener("change",j);let e=document.getElementById("open-project-btn");e&&e.addEventListener("click",L);let t=document.getElementById("quick-save-project-btn");t&&t.addEventListener("click",D);let a=document.getElementById("save-as-project-json-btn");a&&a.addEventListener("click",()=>B()),document.getElementById("add-team-btn").addEventListener("click",A),document.getElementById("clear-storage-btn").addEventListener("click",W),document.getElementById("dashboard-team-filter").addEventListener("change",e=>u(e.target.value));let n=document.getElementById("project-teams");n.addEventListener("change",N),n.addEventListener("input",P),n.addEventListener("click",U),n.addEventListener("mousedown",c),document.addEventListener("click",e=>{e.target.closest(".dependency-dropdown")||(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")))}),document.addEventListener("keydown",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("s"!==e.key.toLowerCase()||e.shiftKey?"s"===e.key.toLowerCase()&&e.shiftKey?(e.preventDefault(),B()):"o"===e.key.toLowerCase()&&(e.preventDefault(),L()):(e.preventDefault(),D()))}),window.addEventListener("dragover",e=>{e.preventDefault()}),window.addEventListener("drop",async e=>{e.preventDefault();let t=e.dataTransfer?.files?.[0];if(t&&t.name.toLowerCase().endsWith(".json"))try{var a=await t.text();try{let e=JSON.parse(a);S(e)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),m("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}}catch(e){console.error("Drop load failed",e)}}),window.addEventListener("beforeunload",e=>{try{$&&x&&(e.preventDefault(),e.returnValue="")}catch{}}),localStorage.getItem("projectPlannerState_v1")?h("Eine gespeicherte Sitzung wurde gefunden. Möchten Sie sie wiederherstellen?",()=>{!function(){try{let e=localStorage.getItem(y);if(e){let t=JSON.parse(e);return t.config.ganttSettings||(t.config.ganttSettings={dayWidth:30,taskColumnWidth:250,axisMode:"days"}),t.config.ganttSettings.axisMode||(t.config.ganttSettings.axisMode="days"),(b=t).teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned"),e.axisMode||(e.axisMode="days")}),b.teams.forEach(e=>o(e.id)),!0}}catch(e){console.error("Could not load state from localStorage",e),localStorage.removeItem(y)}return!1}()?g():(g(),f("saved"))},()=>g()):g();let l=document.getElementById("copyright-text");if(l){let e=new Date().getFullYear();l.textContent=`Copyright \xa9 ${e} Daniel Gruner`}});