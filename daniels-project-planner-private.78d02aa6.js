const e=(e,t)=>Math.round((t-e)/864e5);function t(e){if(!e||"string"!=typeof e)return null;e.includes("T")||e.includes("Z")||(e+="T00:00:00Z");let t=new Date(e);return isNaN(t.getTime())?null:new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()))}function a(e){if(!e||!(e instanceof Date)||isNaN(e))return"–";let t=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCMonth()+1).padStart(2,"0"),n=e.getUTCFullYear();return`${t}.${a}.${n}`}function n(e){return!e||!(e instanceof Date)||isNaN(e)?"":e.toISOString().split("T")[0]}function d(e,t){if(!e)return null;let a=new Date(e.getTime());if(t<=0)return a;let n=0;for(;n<t;)a.setUTCDate(a.getUTCDate()+1),0!==a.getUTCDay()&&6!==a.getUTCDay()&&n++;return a}function l(e,t){if(!e)return null;let a=new Date(e.getTime());if(t<=0)return a;let n=0;for(;n<t;)a.setUTCDate(a.getUTCDate()-1),0!==a.getUTCDay()&&6!==a.getUTCDay()&&n++;return a}function s(e,t){if(!e||!t||e.getTime()===t.getTime())return 0;let a=0,n=new Date(Math.min(e,t)),d=new Date(Math.max(e,t)),l=new Date(n);for(;l<=d;)0!==l.getUTCDay()&&6!==l.getUTCDay()&&a++,l.setUTCDate(l.getUTCDate()+1);return a=Math.max(0,a-1),e>t?-a:a}const i=e=>{let t=e.closest("tr"),a=e.closest(".team-section");return{teamId:a?a.dataset.teamId:null,taskId:t?parseInt(t.dataset.taskId):null}};function r(e){var a,i;let r=v.teams.find(t=>t.id===e);if(!r)return;let c=new Map(r.tasks.map(e=>[e.taskId,e])),p=new Map((r.baselines||[]).map(e=>[e.taskId,e])),u=null,g=null;r.tasks.forEach(e=>{e.cycleError=!1,e.plannedStart_date=t(e.plannedStart),e.plannedEnd_date=t(e.plannedEnd),e.actualEnd_date=t(e.actualEnd);let a=p.get(e.taskId);e.baseline=a?{...a,plannedEnd_date:t(a.plannedEnd)}:null;let n=parseInt(e.duration)||0,d=n>0?n-1:0;if(e.baseline&&e.baseline.plannedEnd_date){let t=l(e.baseline.plannedEnd_date,d);(!u||t<u)&&(u=t)}if(e.actualEnd_date){let t=l(e.actualEnd_date,d);(!g||t<g)&&(g=t)}});let m=0;u&&g&&g>u&&(m=s(u,g));let f=r.tasks.some(e=>!!e.actualEnd_date),y=new Set;r.tasks.forEach(e=>{(e.dependency||[]).forEach(e=>y.add(parseInt(e)))}),r.tasks.forEach(e=>e.isTerminal=!y.has(e.taskId));let{hasCycle:h,cycleNodes:b,sorted:k}=o(r.tasks);if(h)return void b.forEach(e=>{c.has(e)&&(c.get(e).cycleError=!0)});"forward"===r.planningMode?(a=c,k.forEach(e=>{let t=a.get(e),n=parseInt(t.duration)||0,l=t.plannedStart_date||null,s=null;t.dependency&&t.dependency.length>0&&t.dependency.forEach(e=>{let t=a.get(parseInt(e));if(t){let e=t.plannedEnd_date;e&&(!s||e>s)&&(s=e)}});let i=s?d(s,1):null,r=null;t.plannedStart_date=r=i&&l?i>l?i:l:i||l||null,r?t.plannedEnd_date=d(r,n>0?n-1:0):t.plannedEnd_date=null}),function(e,t,a,n){let l=new Map;a.forEach(e=>{let a,s=t.get(e),i=parseInt(s.duration)||0;if(s.actualEnd_date)a=s.actualEnd_date;else{let e=null,t=!0;if(s.dependency&&s.dependency.length>0){let a=null;s.dependency.forEach(e=>{let t=parseInt(e),n=l.get(t);n&&(!a||n>a)&&(a=n)}),a&&(e=d(a,1),t=!1)}if(e||(e=s.plannedStart_date),e){let l=t?d(e,n):e;a=d(l,i>0?i-1:0)}else a=null}l.set(e,a)}),t.forEach(e=>{let t=l.get(e.taskId),a=e.plannedEnd_date;t?e.forwardEnd_date=t:a?e.forwardEnd_date=a:e.forwardEnd_date=null})}(0,c,k,m)):(function(e,t){let a=new Map;e.forEach(e=>a.set(e.taskId,[])),e.forEach(e=>{(e.dependency||[]).forEach(t=>{let n=parseInt(t);a.has(n)&&a.get(n).push(e.taskId)})});for(let n=t.length-1;n>=0;n--){let d,s=t[n],i=e.get(s),r=parseInt(i.duration)||0,o=r>0?r-1:0;if(i.isTerminal)d=i.plannedEnd_date;else{let t=a.get(s),n=null;t&&t.length>0&&t.forEach(t=>{let a=e.get(t);a&&a.plannedStart_date&&(null===n||a.plannedStart_date<n)&&(n=a.plannedStart_date)}),d=n?l(n,1):null}i.plannedEnd_date=d,i.plannedEnd_date?i.plannedStart_date=l(i.plannedEnd_date,o):i.plannedStart_date=null}}(c,k),function(e,t,a,n){let l=new Map,s=new Set;t.forEach(t=>{let a,n=e.get(t),i=parseInt(n.duration)||0;if(n.actualEnd_date){l.set(t,n.actualEnd_date),s.add(t);return}let r=null,o=!1;if(n.dependency&&n.dependency.length>0&&n.dependency.forEach(e=>{let t=parseInt(e),a=l.get(t);a&&((!r||a>r)&&(r=a),s.has(t)&&(o=!0))}),r?(a=d(r,1),o&&s.add(t)):a=n.plannedStart_date,a){let e=d(a,i>0?i-1:0);l.set(t,e)}}),e.forEach(e=>{if(e.actualEnd_date){e.forwardEnd_date=e.actualEnd_date;return}let t=l.get(e.taskId);if(s.has(e.taskId))e.forwardEnd_date=t;else{let t=n&&e.baseline?.plannedEnd_date||e.plannedEnd_date,l=null;t&&(l=a>0?d(t,a):t),e.forwardEnd_date=l}})}(c,k,m,f)),i=r,c.forEach(e=>{let t="baseline"===i.delayReference&&e.baseline?e.baseline.plannedEnd_date:e.plannedEnd_date;t&&e.forwardEnd_date?e.delay=s(t,e.forwardEnd_date):e.delay=null,"Blocked"!==e.status&&(e.status=e.actualEnd_date?"Completed":"Not Started"),e.plannedStart=n(e.plannedStart_date),e.plannedEnd=n(e.plannedEnd_date),e.forwardEnd=n(e.forwardEnd_date)}),r.criticalPath=function(e){let t=new Map(e.tasks.map(e=>[e.taskId,e])),a=new Set;if(0===e.tasks.length)return a;let n=null;if(e.tasks.forEach(e=>{e.forwardEnd_date&&(!n||e.forwardEnd_date>n.forwardEnd_date)&&(n=e)}),!n)return a;let s=n;for(;s&&(a.add(s.taskId),s.dependency&&0!==s.dependency.length);){let e=null,a=l(s.forwardEnd_date,(parseInt(s.duration)||1)-1);s.dependency.forEach(n=>{let l=t.get(parseInt(n));l&&l.forwardEnd_date&&d(l.forwardEnd_date,1).getTime()===a.getTime()&&(!e||l.forwardEnd_date>e.forwardEnd_date)&&(e=l)}),s=e}return a}(r)}function o(e){let t=new Map,a=new Map;e.forEach(e=>{t.set(e.taskId,[]),a.set(e.taskId,0)}),e.forEach(e=>{(e.dependency||[]).forEach(n=>{let d=parseInt(n);t.has(d)&&(t.get(d).push(e.taskId),a.set(e.taskId,(a.get(e.taskId)||0)+1))})});let n=[];a.forEach((e,t)=>{0===e&&n.push(t)});let d=[];for(;n.length>0;){let e=n.shift();d.push(e),(t.get(e)||[]).forEach(e=>{a.set(e,a.get(e)-1),0===a.get(e)&&n.push(e)})}let l=d.length!==e.length,s=[];return l&&a.forEach((e,t)=>{e>0&&s.push(t)}),{sorted:d,hasCycle:l,cycleNodes:s}}function c(e){if(!e.target.classList.contains("gantt-resizer"))return;e.preventDefault();let t=e.target.closest(".gantt-container"),a=t.querySelector(".gantt-tasks"),n=e.clientX,d=a.offsetWidth,l=e=>{let a=d+(e.clientX-n);a>150&&a<800&&(t.style.gridTemplateColumns=`${a}px 5px 1fr`)},s=()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",s),v.config.ganttSettings.taskColumnWidth=a.offsetWidth,k(m)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",s)}let p=null;function u(e="all"){let t=document.getElementById("dashboard-metrics");if(!t)return;let n=function(e){if("all"===e)return v.teams.flatMap(e=>e.tasks);let t=v.teams.find(t=>t.id===e);return t?t.tasks:[]}(e);if(0===n.length){t.innerHTML='<p class="col-span-full text-center text-gray-500">Keine Daten für das Dashboard verfügbar.</p>',p&&(p.destroy(),p=null);return}let{endDate:d,totalDelay:l,completionPercentage:s,statusCounts:i}=function(e){let t=null,a=0,n=0,d={Completed:0,Blocked:0,"Not Started":0};e.forEach(e=>{e.forwardEnd_date&&(!t||e.forwardEnd_date>t)&&(t=e.forwardEnd_date),e.delay>a&&(a=e.delay),"Completed"===e.status&&n++,void 0!==d[e.status]?d[e.status]++:d["Not Started"]++});let l=e.length>0?Math.round(n/e.length*100):0;return{endDate:t,totalDelay:a,completionPercentage:l,statusCounts:d}}(n);t.innerHTML=`
        <div class="kpi-card">
            <span class="kpi-title">Projekt-Enddatum</span>
            <span class="kpi-value">${a(d)}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Maximaler Verzug (Tage)</span>
            <span class="kpi-value ${l>0?"text-red-600":"text-gray-800"}">${l}</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Abgeschlossen</span>
            <span class="kpi-value text-green-600">${s}%</span>
        </div>
        <div class="kpi-card kpi-chart-container">
            <canvas id="status-chart"></canvas>
        </div>
    `,function(e){let t=document.getElementById("status-chart")?.getContext("2d");t&&(p&&(p.destroy(),p=null),p=new Chart(t,{type:"doughnut",data:{labels:["Abgeschlossen","Blockiert","Nicht begonnen"],datasets:[{data:[e.Completed,e.Blocked,e["Not Started"]],backgroundColor:["#10B981","#F59E0B","#6B7280"],borderColor:"#ffffff",borderWidth:2,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:"Aufgaben nach Status"}}}}))}(i)}function g(){let{config:n,teams:d}=v;document.getElementById("main-title").textContent=n.title,document.getElementById("main-subtitle").textContent=n.subtitle;let s=document.getElementById("project-teams"),i=window.scrollY,r={};document.querySelectorAll(".gantt-wrapper:not(.hidden)").forEach(e=>{r[e.closest(".team-section").dataset.teamId]=!0}),s.innerHTML="";let o=document.getElementById("initial-prompt");0===d.length?(o&&(o.style.display="block"),document.getElementById("dashboard-container").classList.add("hidden"),m()):(o&&(o.style.display="none"),document.getElementById("dashboard-container").classList.remove("hidden"),function(){let e=document.getElementById("dashboard-team-filter");if(!e)return;let t=e.value;e.innerHTML='<option value="all">Gesamtes Projekt</option>',v.teams.forEach(t=>{let a=document.createElement("option");a.value=t.id,a.textContent=t.name,e.appendChild(a)}),v.teams.some(e=>e.id===t)?e.value=t:e.value="all"}(),u(document.getElementById("dashboard-team-filter").value),d.forEach(n=>{let d=function(n){let d=document.createElement("div");d.id=n.id,d.className="team-section bg-white shadow-lg rounded-lg p-6",d.dataset.teamId=n.id;let s=["w-20","w-24","w-28","w-32","w-36","w-40","w-48","w-56","w-64","w-72","w-80","w-96"],i=v.config.columns.filter(e=>"forward"===n.planningMode?"plannedEnd"!==e.key||e.type.startsWith("display"):"backward"!==n.planningMode||"plannedStart"!==e.key),r=i.map(e=>{let t=s.map(t=>`<option value="${t}" ${e.width===t?"selected":""}>${t.replace("w-","")}</option>`).join("");return`<th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${e.width||""}" data-key="${e.key}">
                    <div class="flex flex-col space-y-1">
                        <span>${e.label}</span>
                        <select data-column-key="${e.key}" class="column-width-select text-black font-normal normal-case p-1 text-xs rounded border bg-gray-100 hover:bg-gray-200">${t}</select>
                    </div>
                </th>`}).join(""),o=v.config.ganttSettings?.dayWidth||30,c=n.axisMode||"days";return d.innerHTML=`
        <div class="team-header flex justify-between items-end mb-4 gap-4 flex-wrap">
            <div class="flex items-end gap-2">
                <div class="flex items-center gap-2 cursor-pointer toggle-collapse-btn">
                    <svg class="w-6 h-6 text-gray-600 transition-transform ${n.isCollapsed?"-rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <h2 contenteditable="true" class="team-name text-2xl font-bold text-gray-700 p-2">${n.name}</h2>
                </div>
                <!-- --- NEU: Dropdown f\xfcr den Planungsmodus --- -->
                <div class="planning-mode-selector ml-4 flex flex-col items-start">
                    <label for="planning-mode-${n.id}" class="text-xs font-medium text-gray-700 mb-1">Planungsmodus</label>
                    <select id="planning-mode-${n.id}" class="planning-mode-select p-2 border rounded-md bg-gray-50">
                        <option value="backward" ${"backward"===n.planningMode?"selected":""}>Backward</option>
                        <option value="forward" ${"forward"===n.planningMode?"selected":""}>Forward</option>
                    </select>
                </div>
                <!-- --- NEU: Dropdown f\xfcr die Delay-Referenz --- -->
                <div class="delay-reference-selector ml-4 flex flex-col items-start">
                    <label for="delay-reference-${n.id}" class="text-xs font-medium text-gray-700 mb-1">Delay-Referenz</label>
                    <select id="delay-reference-${n.id}" class="delay-reference-select p-2 border rounded-md bg-gray-50">
                        <option value="planned" ${"planned"===n.delayReference?"selected":""}>Planned</option>
                        <option value="baseline" ${"baseline"===n.delayReference?"selected":""}>Baseline</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 flex-wrap justify-end items-center">
                <button class="action-btn duplicate-team-btn bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">Team duplizieren</button>
                <button class="action-btn set-team-baseline-btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition ${n.isCollapsed?"hidden":""}">Baseline setzen</button>
                <button class="action-btn toggle-gantt-btn bg-cyan-600 text-white px-4 py-2 rounded-md hover:bg-cyan-700 transition ${n.isCollapsed?"hidden":""}">Gantt-Chart anzeigen</button>
                <button class="action-btn sort-tasks-btn bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition ${n.isCollapsed?"hidden":""}">Tasks sortieren</button>
                <button class="action-btn delete-team-btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Team l\xf6schen</button>
            </div>
        </div>
        <div class="team-content ${n.isCollapsed?"hidden":""}">
            <div class="gantt-controls hidden flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 p-3 bg-gray-50 rounded-md border">
                <label class="text-sm font-medium text-gray-700">Zoom:</label>
                <div class="flex items-center gap-2">
                    <button data-gantt-zoom="out" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">-</button>
                    <span class="text-sm font-semibold text-gray-700 w-16 text-center">${o}px/Tag</span>
                    <button data-gantt-zoom="in" class="gantt-zoom-btn action-btn bg-gray-200 px-2.5 py-1 text-lg font-bold rounded-md hover:bg-gray-300">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" class="critical-path-toggle" ${n.showCriticalPath?"checked":""}>
                    <label class="text-sm font-medium text-gray-700 select-none">Kritischer Pfad</label>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Achse:</label>
                    <select class="gantt-axis-select p-2 border rounded-md bg-gray-50">
                        <option value="days" ${"days"===c?"selected":""}>Tage</option>
                        <option value="weeks" ${"weeks"===c?"selected":""}>Wochen (KW)</option>
                        <option value="months" ${"months"===c?"selected":""}>Monate</option>
                        <option value="quarters" ${"quarters"===c?"selected":""}>Quartale</option>
                    </select>
                </div>
                <div class="ml-auto">
                    <button class="action-btn screenshot-gantt-btn bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition text-sm">Gantt-Chart exportieren</button>
                </div>
            </div>
            <div class="gantt-wrapper hidden mb-6"></div>
            <div class="table-container">
                <table class="project-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>${r}<th></th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${n.tasks.map(e=>(function(e,n,d){let l=`${n.cycleError?"cycle-error":""}`,s=d.map(d=>{let l="",s=n[d.key]||"",i=n.dependency&&n.dependency.length>0;switch(d.type){case"text-input":l=`<input type="text" data-key="${d.key}" value="${s}" placeholder="${d.placeholder||""}">`;break;case"textarea":l=`<textarea data-key="${d.key}" rows="1" placeholder="${d.placeholder||""}">${s}</textarea>`;break;case"number-input":l=`<input type="number" data-key="${d.key}" value="${s||d.default}" min="${d.min||0}">`;break;case"date-input":let r=!1;("forward"===e.planningMode&&"plannedStart"===d.key&&i||"backward"===e.planningMode&&"plannedEnd"===d.key&&!n.isTerminal)&&(r=!0),l=r?`<span data-key="${d.key}">${a(t(n[d.key]))}</span>`:`<input type="date" data-key="${d.key}" value="${s}">`;break;case"select-dependency":let o=n.dependency||[],c=o.map(t=>e.tasks.find(e=>e.taskId==t)?`#${t}`:"").filter(Boolean).join(", "),p=e.tasks.filter(e=>e.taskId!==n.taskId).map(e=>`
                    <label class="dependency-option">
                        <input type="checkbox" class="dependency-checkbox" value="${e.taskId}" ${o.includes(String(e.taskId))?"checked":""}>
                        <span>#${e.taskId}: ${(e.taskName||"").substring(0,40)}</span>
                    </label>`).join("");l=`<div class="dependency-dropdown" data-key="dependency"><button type="button" class="dependency-dropdown-button w-full border rounded-md p-2 bg-white text-left truncate">${c||"Abhängigkeiten wählen..."}</button><div class="dependency-dropdown-panel">${p}</div></div>`;break;case"select-status":let u=d.options.map(e=>`<option value="${e}" ${s===e?"selected":""}>${e}</option>`).join("");l=`<select data-key="status">${u}</select>`;break;case"display":let g="forwardEnd"===d.key||"plannedEnd"===d.key?a(t(s)):s;l=`<span data-key="${d.key}" class="${d.isBold?"font-semibold":""}">${g}</span>`;break;case"display-delay":let m=null===n.delay?"-":n.delay,f="";"number"==typeof n.delay&&(f=n.delay<0?"delay-negative":n.delay>0?"delay-positive":"delay-on-time"),l=`<div data-key="${d.key}" class="delay text-center font-bold p-2 rounded-md ${f}">${m}</div>`}let y="";return"select-status"===d.type&&(y=({"Not Started":"status-not-started",Completed:"status-completed",Blocked:"status-blocked"})[n.status]||""),`<td class="${y}">${l}</td>`}).join("");return`<tr data-task-id="${n.taskId}" class="${l}">${s}<td><button class="delete-task-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td></tr>`})(n,e,i)).join("")}</tbody>
                </table>
            </div>
            <div class="mt-4"><button class="action-btn add-task-btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Task hinzuf\xfcgen +</button></div>
        </div>`,n.tasks.length>0&&d.querySelector(".gantt-wrapper").appendChild(function(t){let a=document.createElement("div");if(!t.tasks||0===t.tasks.length)return a;let n=t.tasks,d=v.config.ganttSettings?.dayWidth||30,s=v.config.ganttSettings?.taskColumnWidth||250,i=null,r=null;if(n.forEach(e=>{if(e.forwardEnd_date){let t=parseInt(e.duration)||1,a=l(e.forwardEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.forwardEnd_date>r)&&(r=e.forwardEnd_date)}if("baseline"===t.delayReference){if(e.baseline&&e.baseline.plannedEnd_date){let t=parseInt(e.baseline.duration)||1,a=l(e.baseline.plannedEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.baseline.plannedEnd_date>r)&&(r=e.baseline.plannedEnd_date)}}else if(e.plannedEnd_date){let t=parseInt(e.duration)||1,a=l(e.plannedEnd_date,t>0?t-1:0);(!i||a<i)&&(i=a),(!r||e.plannedEnd_date>r)&&(r=e.plannedEnd_date)}}),!i||!r)return a.innerHTML='<p class="text-center text-gray-500 p-4">Keine gültigen Daten für das Gantt-Diagramm vorhanden.</p>',a;let o=new Date(i);o.setUTCDate(o.getUTCDate()-5);let c=new Date(r);c.setUTCDate(c.getUTCDate()+5);let p="",u="",g="",m="",f="",y="",h=new Date(o),b=0,k=-1,w=0,E=-1,x=-1,$=0,C=-1,S=-1,I=0,T=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],_=d<25?"0.65rem":"0.75rem",L=d<25?"0.7rem":"0.8rem";for(;h<=c;){let t=h.getUTCDate(),a=h.getUTCMonth(),n=h.getUTCFullYear(),l=[0,6].includes(h.getUTCDay()),s=Math.floor(a/3)+1;a!==k&&(-1!==k&&(u+=`<div class="gantt-month" style="width: ${w*d}px; font-size: ${L};">${T[k]} ${h.getFullYear()}</div>`),k=a,w=0),w++,(s!==C||n!==S)&&(-1!==C&&(p+=`<div class="gantt-quarter" style="width: ${I*d}px; font-size: ${L};">Q${C}/${String(S).slice(-2)}</div>`),C=s,S=n,I=0),I++;let{week:i,year:r}=function(e){let t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),a=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-a);let n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return{week:Math.ceil(((t-n)/864e5+1)/7),year:t.getUTCFullYear()}}(h);(i!==E||r!==x)&&(-1!==E&&(g+=`<div class="gantt-week" style="width: ${$*d}px; font-size: ${_};">KW ${E}</div>`),E=i,x=r,$=0),$++,m+=`<div class="gantt-day ${l?"weekend":""}" style="width: ${d}px; font-size: ${_};">${t}</div>`,l&&(y+=`<div class="gantt-weekend-col" style="left: ${e(o,h)*d}px; width: ${d}px;"></div>`),h.setUTCDate(h.getUTCDate()+1),b++}u+=`<div class="gantt-month" style="width: ${w*d}px; font-size: ${L};">${T[k]} ${c.getFullYear()}</div>`,I>0&&(p+=`<div class="gantt-quarter" style="width: ${I*d}px; font-size: ${L};">Q${C}/${String(S).slice(-2)}</div>`),$>0&&(g+=`<div class="gantt-week" style="width: ${$*d}px; font-size: ${_};">KW ${E}</div>`);let D=b*d,M=t.axisMode||"days",B="",j="";"days"===M?(B=`
                <div class="gantt-header">${u}</div>
                <div class="gantt-days">${m}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div><div class="gantt-days"><div class="gantt-day">&nbsp;</div></div></div>'):"weeks"===M?(B=`
                <div class="gantt-header">${u}</div>
                <div class="gantt-weeks">${g}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div><div class="gantt-weeks"><div class="gantt-week">&nbsp;</div></div></div>'):"months"===M?(B=`
                <div class="gantt-quarters">${p}</div>
                <div class="gantt-header">${u}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-quarters"><div class="gantt-quarter">&nbsp;</div></div><div class="gantt-header"><div class="gantt-month">&nbsp;</div></div></div>'):"quarters"===M&&(B=`
                <div class="gantt-quarters">${p}</div>`,j='<div style="background-color: #f9fafb; visibility: hidden;"><div class="gantt-quarters"><div class="gantt-quarter">&nbsp;</div></div></div>'),n.forEach(()=>f+=`<div class="gantt-row" style="width: ${D}px"></div>`);let N=new Date;N.setUTCHours(0,0,0,0);let U=e(o,N)*d,P=N>=o&&N<=c?`<div class="gantt-today-marker" style="left: ${U}px;"></div>`:"",A=n.map((a,n)=>{let s="",i=37*n;if("baseline"===t.delayReference){if(a.baseline&&a.baseline.plannedEnd_date){let t=parseInt(a.baseline.duration)||1,n=l(a.baseline.plannedEnd_date,t>0?t-1:0),r=e(n,a.baseline.plannedEnd_date)+1,c=e(o,n)*d;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*d}px;" title="Baseline End: ${a.baseline.plannedEnd}"></div>`}}else if(a.plannedEnd_date){let t=parseInt(a.duration)||1,n=l(a.plannedEnd_date,t>0?t-1:0),r=e(n,a.plannedEnd_date)+1,c=e(o,n)*d;s+=`<div class="gantt-bar-baseline" style="top: ${i}px; left: ${c}px; width: ${r*d}px;" title="Planned End: ${a.plannedEnd}"></div>`}if(a.forwardEnd_date){let n=parseInt(a.duration)||1,r=l(a.forwardEnd_date,n>0?n-1:0),c=e(r,a.forwardEnd_date)+1,p=e(o,r)*d,u="Completed"===a.status?"status-completed":"Blocked"===a.status?"status-blocked":"",g=!!t.showCriticalPath,m=t.criticalPath&&t.criticalPath.has(a.taskId),f=`#${a.taskId}: ${a.taskName||""}`;s+=`<div class="gantt-bar ${u} ${g?m?"is-critical":"dimmed":""}" style="top: ${i}px; left: ${p}px; width: ${c*d}px;" title="${f}">
                            <span><strong class="mr-1">#${a.taskId}</strong>${a.taskName||""}</span>
                       </div>`}return s}).join(""),q=n.map(e=>`<div class="gantt-task-name" title="${e.taskName}">#${e.taskId}: ${e.taskName||""}</div>`).join("");return a.className="gantt-container",a.style.gridTemplateColumns=`${s}px 5px 1fr`,a.innerHTML=`
        <div class="gantt-tasks">${j}${q}</div>
        <div class="gantt-resizer"></div>
        <div class="gantt-timeline">
            <div class="gantt-header-container" style="width: ${D}px">
                ${B}
            </div>
            <div class="gantt-rows" style="width: ${D}px">${y}${f}${A}</div>
            ${P}
        </div>`,a}(n)),d}(n);r[n.id]&&(d.querySelector(".gantt-wrapper").classList.remove("hidden"),d.querySelector(".gantt-controls").classList.remove("hidden"),d.querySelector(".toggle-gantt-btn").textContent="Gantt-Chart verbergen"),s.appendChild(d)})),window.scrollTo(0,i)}function m(e){let t=document.getElementById("save-status-text"),a=document.getElementById("save-status-warning");switch(e){case"saving":t.textContent="Speichern...",t.classList.remove("text-green-600"),a.classList.add("hidden");break;case"saved":t.textContent="✓ Alle Änderungen im Browser-Cache gespeichert",t.classList.add("text-green-600","font-medium"),a.classList.remove("hidden");break;default:t.textContent="",a.classList.add("hidden")}}function f(e){let t=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="none",t.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>t.classList.remove("visible")}function y(e,t,a=()=>{}){let n=document.getElementById("modal");document.getElementById("modal-text").textContent=e,document.getElementById("modal-confirm-btn").style.display="block",document.getElementById("modal-cancel-btn").style.display="block",n.classList.add("visible"),document.getElementById("modal-confirm-btn").onclick=()=>{n.classList.remove("visible"),t()},document.getElementById("modal-cancel-btn").onclick=()=>{n.classList.remove("visible"),a()}}const h="projectPlannerState_v1";let b=null,v={config:{title:"Projektplaner",subtitle:"Lade deine Konfigurations- und Projektdateien, um zu beginnen.",ganttSettings:{dayWidth:30,taskColumnWidth:250,axisMode:"days"},columns:[{key:"taskId",label:"ID",type:"display",width:"w-20"},{key:"taskName",label:"Task",type:"textarea",width:"w-80",placeholder:"Task name..."},{key:"responsible",label:"Responsible",type:"text-input",width:"w-40",placeholder:"Name..."},{key:"comment",label:"Comment",type:"textarea",width:"w-72",placeholder:"Note..."},{key:"dependency",label:"Dependency",type:"select-dependency",width:"w-56"},{key:"duration",label:"Duration (Days)",type:"number-input",width:"w-28",min:0,default:1},{key:"plannedStart",label:"Planned Start",type:"date-input",width:"w-40"},{key:"plannedEnd",label:"Planned End",type:"date-input",width:"w-40"},{key:"actualEnd",label:"Actual End",type:"date-input",width:"w-40"},{key:"forwardEnd",label:"New End",type:"display",width:"w-40",isBold:!0},{key:"delay",label:"Delay (Days)",type:"display-delay",width:"w-28",isBold:!0,isCentered:!0},{key:"status",label:"Status",type:"select-status",width:"w-40",options:["Not Started","Blocked","Completed"]}]},teams:[]};function k(e){clearTimeout(b),e&&e("saving"),b=setTimeout(()=>{try{let t=JSON.parse(JSON.stringify(v,(e,t)=>{if(!e.endsWith("_date"))return t}));localStorage.setItem(h,JSON.stringify(t)),e&&e("saved")}catch(t){console.error("Could not save state to localStorage",t),f("Fehler: Der Projektstatus konnte nicht lokal gespeichert werden."),e&&e("error")}},500)}function w(e,t,a,n){let d=v.teams.find(t=>t.id===e);if(!d)return;let l=d.tasks.find(e=>e.taskId===t);l&&(l[a]=n)}let E=null,x=!1;function $(){return x}function C(){x=!0,k(m)}function S(){if(!v)return"{}";v.config.title=document.getElementById("main-title").textContent,v.config.subtitle=document.getElementById("main-subtitle").textContent;let e=document.querySelector(".gantt-wrapper:not(.hidden) .gantt-tasks");e&&e.offsetWidth>0&&(v.config.ganttSettings.taskColumnWidth=e.offsetWidth);let t=v.teams.map(e=>{let t=(e=>{let t=new Set;return e.forEach(e=>(e.dependency||[]).forEach(e=>t.add(parseInt(e)))),t})(e.tasks||[]),a=(e.tasks||[]).map(a=>{let n=!t.has(a.taskId),d=!a.dependency||0===a.dependency.length,l={taskId:a.taskId};return l.duration=a.duration,a.taskName&&(l.taskName=a.taskName),a.responsible&&(l.responsible=a.responsible),a.comment&&(l.comment=a.comment),a.dependency&&a.dependency.length>0&&(l.dependency=a.dependency),"backward"===e.planningMode?n&&a.plannedEnd&&(l.plannedEnd=a.plannedEnd):d&&a.plannedStart&&(l.plannedStart=a.plannedStart),a.actualEnd&&(l.actualEnd=a.actualEnd),"Blocked"===a.status&&(l.status="Blocked"),l}),n=(e.baselines||[]).map(e=>{let t={taskId:e.taskId};return e.plannedEnd&&(t.plannedEnd=e.plannedEnd),e.duration&&(t.duration=e.duration),t});return{id:e.id,name:e.name,planningMode:e.planningMode||"backward",delayReference:e.delayReference||"planned",isCollapsed:!!e.isCollapsed,lastTaskId:e.lastTaskId||e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0,tasks:a,baselines:n}});return JSON.stringify({config:v.config,teams:t},(e,t)=>{if(!("string"==typeof e&&e.endsWith("_date")))return t},2)}function I(e){let t=e.config||e?.appState?.config,a=e.teams||e?.appState?.teams;return t&&Array.isArray(t.columns)&&Array.isArray(a)?(t.ganttSettings={...v.config.ganttSettings,...t.ganttSettings},v.config=t,v.teams=a,v.teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned"),e.lastTaskId||(e.lastTaskId=e.tasks?.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0)||0)}),v.teams.forEach(e=>r(e.id)),g(),k(null),f("Projektdatei erfolgreich geladen!"),!0):(f("Ungültige Projektdatei. Erwartet { config, teams }."),!1)}function T(){return window.isSecureContext&&"function"==typeof window.showOpenFilePicker&&"function"==typeof window.showSaveFilePicker}async function _(e,t){let a={mode:t?"readwrite":"read"};return await e.queryPermission(a)==="granted"||await e.requestPermission(a)==="granted"}async function L(e,t){let a=await e.createWritable();await a.write(t),await a.close()}async function D(){try{if(!T())return void document.getElementById("project-json-upload").click();let[e]=await window.showOpenFilePicker({types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1,multiple:!1});if(!e||!await _(e,!1))return;let t=await e.getFile(),a=await t.text(),n=JSON.parse(a);I(n)&&(E=e,x=!1)}catch(e){e?.name!=="AbortError"&&(console.error("Open via picker failed:",e),f("Datei konnte nicht geöffnet werden."))}}async function M(){try{let e=S();if(E&&T()&&await _(E,!0)){await L(E,e),x=!1,f("Projektdatei gespeichert (Schnell speichern).");return}await B(e)}catch(e){console.error("Quick save failed:",e),f("Speichern fehlgeschlagen.")}}async function B(e=null){try{let t=e??S();if(T()){let e=(document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt")+".project.json",a=await window.showSaveFilePicker({suggestedName:e,types:[{description:"Project JSON",accept:{"application/json":[".json",".project.json"]}}],excludeAcceptAllOption:!1});if(!await _(a,!0))return;await L(a,t),E=a,x=!1,f("Projektdatei gespeichert.");return}let a=new Blob([t],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(a);let d=document.getElementById("main-title").textContent.trim().replace(/\s+/g,"_")||"projekt";n.download=`${d}.project.json`,n.click(),URL.revokeObjectURL(n.href),x=!1,f("Projektdatei gespeichert.")}catch(e){e?.name!=="AbortError"&&(console.error("Save As failed:",e),f("Speichern fehlgeschlagen."))}}function j(e){let t=e.target.files[0];if(!t)return;let a=new FileReader;a.onload=e=>{try{let t=JSON.parse(e.target.result);I(t)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),f("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}},a.readAsText(t)}function N(e){let t=e.target,{teamId:a,taskId:n}=i(t);if(!a)return;let d=v.teams.find(e=>e.id===a);if(!d)return;if(t.classList.contains("column-width-select"))return void function(e,t){let a=v.config.columns.find(t=>t.key===e);a&&(a.width=t),g(),C()}(t.dataset.columnKey,t.value);if(t.classList.contains("planning-mode-select")){d.planningMode=t.value,r(a),g(),C();return}if(t.classList.contains("delay-reference-select")){d.delayReference=t.value,r(a),g(),C();return}if(t.classList.contains("gantt-axis-select")){d.axisMode=t.value,g(),C();return}if(t.classList.contains("critical-path-toggle")){d.showCriticalPath=t.checked,g(),C();return}let l=!1;if(t.classList.contains("dependency-checkbox"))w(a,n,"dependency",Array.from(t.closest(".dependency-dropdown").querySelectorAll(".dependency-checkbox:checked")).map(e=>e.value)),l=!0;else{let e=t.dataset.key;if(w(a,n,e,t.value),["duration","plannedEnd","actualEnd","dependency","status","plannedStart"].includes(e)&&(l=!0),"status"===e){let e=d.tasks.find(e=>e.taskId===n);if(e)if("Completed"===t.value){let t=new Date,a=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0"),d=String(t.getUTCDate()).padStart(2,"0");e.actualEnd=`${a}-${n}-${d}`}else e.actualEnd&&(e.actualEnd="")}if("actualEnd"===e){let e=d.tasks.find(e=>e.taskId===n);e&&(t.value?e.status="Completed":"Completed"===e.status&&(e.status="Not Started"))}}l&&r(a),g(),C()}function U(e){let t=e.target,{teamId:a,taskId:n}=i(t);if("main-title"===t.id||"main-subtitle"===t.id){v.config["main-title"===t.id?"title":"subtitle"]=t.textContent,C();return}if(a){if(t.classList.contains("team-name")){let e=v.teams.find(e=>e.id===a);e&&(e.name=t.textContent)}else{let e=t.dataset.key;"TEXTAREA"===t.tagName&&(t.style.height="auto",t.style.height=t.scrollHeight+"px"),w(a,n,e,t.value)}C()}}function P(e){let t=e.target,{teamId:a,taskId:n}=i(t);if(a){if(t.closest(".toggle-collapse-btn")&&!t.closest(".team-name")){let e=v.teams.find(e=>e.id===a);e&&(e.isCollapsed=!e.isCollapsed,C(),g());return}if(t.classList.contains("gantt-zoom-btn")){let e=t.dataset.ganttZoom,a=v.config.ganttSettings.dayWidth;a="in"===e?Math.min(60,a+2):Math.max(2,a-2),v.config.ganttSettings.dayWidth=a,g(),C();return}if(t.classList.contains("toggle-gantt-btn")){let e=document.getElementById(a),n=e.querySelector(".gantt-wrapper"),d=e.querySelector(".gantt-controls"),l=n.classList.toggle("hidden");d.classList.toggle("hidden",l),t.textContent=l?"Gantt-Chart anzeigen":"Gantt-Chart verbergen";return}if(t.classList.contains("dependency-dropdown-button")){let e=t.nextElementSibling,a=e.classList.contains("visible");if(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),!a){e.classList.add("visible");let a=t.closest(".team-section");a?.classList.add("team-section-active"),a?.querySelector(".team-content")?.classList.add("overflow-visible"),a?.querySelector(".table-container")?.classList.add("overflow-visible")}}else t.classList.contains("add-task-btn")?function(e){let t=v.teams.find(t=>t.id===e);if(!t)return;t.lastTaskId++;let a={taskId:t.lastTaskId,dependency:[]};v.config.columns.forEach(e=>{e.default&&(a[e.key]=e.default)}),t.tasks.push(a),r(e),g(),C()}(a):t.classList.contains("delete-task-btn")?y(`M\xf6chtest du Task ${n} wirklich l\xf6schen?`,()=>(function(e,t){let a=v.teams.find(t=>t.id===e);a&&(a.tasks=a.tasks.filter(e=>e.taskId!==t),a.tasks.forEach(e=>{e.dependency?.includes(String(t))&&(e.dependency=e.dependency.filter(e=>e!==String(t)))}),r(e),g(),C())})(a,n)):t.classList.contains("sort-tasks-btn")?function(e){let t=v.teams.find(t=>t.id===e);if(!t)return;let{sorted:a,hasCycle:n}=o(t.tasks);if(n)return f("Fehler: Ein zirkulärer Verweis wurde entdeckt. Bitte die Abhängigkeiten korrigieren.");t.tasks=a.map(e=>t.tasks.find(t=>t.taskId===e)),g(),C()}(a):t.classList.contains("set-team-baseline-btn")?function(e){let t=v.teams.find(t=>t.id===e);t&&y(`M\xf6chten Sie den aktuellen Status f\xfcr Team "${t.name}" als Baseline festlegen? Eine bestehende Baseline f\xfcr dieses Team wird \xfcberschrieben.`,()=>{t.baselines=JSON.parse(JSON.stringify(t.tasks)),r(t.id),g(),C(),f(`Baseline f\xfcr Team "${t.name}" wurde erfolgreich gesetzt!`)})}(a):t.classList.contains("screenshot-gantt-btn")?q(a,t):t.classList.contains("duplicate-team-btn")?function(e){let t=v.teams.find(t=>t.id===e);if(!t)return;let a=v.teams.map(e=>parseInt(e.id.replace("team",""))||0),n=(a.length>0?Math.max(...a):0)+1,d=`team${n}`,l=(t.tasks||[]).map(e=>(e=>{let{plannedStart_date:t,plannedEnd_date:a,actualEnd_date:n,forwardEnd_date:d,baseline:l,cycleError:s,isTerminal:i,...r}=e,o=(r.dependency||[]).map(e=>String(e));return{...r,dependency:o}})({...e})),s=JSON.parse(JSON.stringify(t.baselines||[])),i=l.reduce((e,t)=>Math.max(e,parseInt(t.taskId)||0),0),o={id:d,name:`${t.name} (Kopie)`,tasks:l,baselines:s,lastTaskId:i,isCollapsed:t.isCollapsed||!1,planningMode:t.planningMode||"backward",delayReference:t.delayReference||"planned",showCriticalPath:t.showCriticalPath||!1,axisMode:t.axisMode||"days"};v.teams.push(o),r(o.id),g(),C(),f(`Team "${t.name}" wurde dupliziert.`)}(a):t.classList.contains("delete-team-btn")&&function(e){let t=v.teams.find(t=>t.id===e);t&&y(`M\xf6chtest du das Team "${t.name}" wirklich l\xf6schen? Diese Aktion kann nicht r\xfcckg\xe4ngig gemacht werden.`,()=>{v.teams=v.teams.filter(t=>t.id!==e),g(),C(),f(`Team "${t.name}" wurde gel\xf6scht.`)})}(a)}}function A(){let e=v.teams.map(e=>parseInt(e.id.replace("team",""))||0),t=(e.length>0?Math.max(...e):0)+1;v.teams.push({id:`team${t}`,name:`Neues Team ${t}`,tasks:[],lastTaskId:0,baselines:[],isCollapsed:!1,planningMode:"backward",delayReference:"planned",showCriticalPath:!1,axisMode:"days"}),g(),C()}async function q(e,t){let a=document.getElementById(e),n=a?.querySelector(".gantt-container"),d=v.teams.find(t=>t.id===e);if(!n||!d)return void f("Fehler: Das Gantt-Chart zum Exportieren wurde nicht gefunden.");let l=t.textContent;t.textContent="Exportiere...",t.disabled=!0;let s=n.querySelector(".gantt-timeline"),i=s.querySelector(".gantt-header-container").scrollWidth,r=n.querySelector(".gantt-tasks").offsetWidth,o=n.style.cssText,c=s.style.cssText;n.style.width=`${r+i+10}px`,n.style.gridTemplateColumns=`${r}px 5px ${i}px`,s.style.overflowX="visible";try{let e=await html2canvas(n,{useCORS:!0,scale:2,backgroundColor:"#ffffff",width:n.scrollWidth,height:n.scrollHeight,windowWidth:n.scrollWidth,windowHeight:n.scrollHeight}),t=document.createElement("a"),a=d.name.replace(/\s+/g,"_");t.download=`Gantt-Chart_${a}.png`,t.href=e.toDataURL("image/png"),t.click()}catch(e){console.error("Fehler beim Erstellen des Screenshots:",e),f("Ein unerwarteter Fehler ist beim Exportieren aufgetreten.")}finally{t.textContent=l,t.disabled=!1,n.style.cssText=o,s.style.cssText=c}}function W(){y("Möchten Sie wirklich alle lokal gespeicherten Daten löschen? Dies kann nicht rückgängig gemacht werden und die Seite wird neu geladen.",()=>{localStorage.removeItem("projectPlannerState_v1"),m(),f("Lokale Daten wurden gelöscht. Seite wird neu geladen."),setTimeout(()=>window.location.reload(),1500)})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("project-json-upload").addEventListener("change",j);let e=document.getElementById("open-project-btn");e&&e.addEventListener("click",D);let t=document.getElementById("quick-save-project-btn");t&&t.addEventListener("click",M);let a=document.getElementById("save-as-project-json-btn");a&&a.addEventListener("click",()=>B()),document.getElementById("add-team-btn").addEventListener("click",A),document.getElementById("clear-storage-btn").addEventListener("click",W),document.getElementById("dashboard-team-filter").addEventListener("change",e=>u(e.target.value));let n=document.getElementById("project-teams");n.addEventListener("change",N),n.addEventListener("input",U),n.addEventListener("click",P),n.addEventListener("mousedown",c),document.addEventListener("click",e=>{e.target.closest(".dependency-dropdown")||(document.querySelectorAll(".dependency-dropdown-panel.visible").forEach(e=>e.classList.remove("visible")),document.querySelectorAll(".team-section-active").forEach(e=>e.classList.remove("team-section-active")),document.querySelectorAll(".table-container.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")),document.querySelectorAll(".team-content.overflow-visible").forEach(e=>e.classList.remove("overflow-visible")))}),document.addEventListener("keydown",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("s"!==e.key.toLowerCase()||e.shiftKey?"s"===e.key.toLowerCase()&&e.shiftKey?(e.preventDefault(),B()):"o"===e.key.toLowerCase()&&(e.preventDefault(),D()):(e.preventDefault(),M()))}),window.addEventListener("dragover",e=>{e.preventDefault()}),window.addEventListener("drop",async e=>{e.preventDefault();let t=e.dataTransfer?.files?.[0];if(t&&t.name.toLowerCase().endsWith(".json"))try{var a=await t.text();try{let e=JSON.parse(a);I(e)&&(E=null,x=!1)}catch(e){console.error("Projekt-JSON Parse Error:",e),f("Ein Fehler ist beim Laden der Projektdatei aufgetreten.")}}catch(e){console.error("Drop load failed",e)}}),window.addEventListener("beforeunload",e=>{try{$&&x&&(e.preventDefault(),e.returnValue="")}catch{}}),localStorage.getItem("projectPlannerState_v1")?y("Eine gespeicherte Sitzung wurde gefunden. Möchten Sie sie wiederherstellen?",()=>{!function(){try{let e=localStorage.getItem(h);if(e){let t=JSON.parse(e);return t.config.ganttSettings||(t.config.ganttSettings={dayWidth:30,taskColumnWidth:250,axisMode:"days"}),t.config.ganttSettings.axisMode||(t.config.ganttSettings.axisMode="days"),(v=t).teams.forEach(e=>{e.baselines&&Array.isArray(e.baselines)||(e.baselines=[]),"boolean"!=typeof e.isCollapsed&&(e.isCollapsed=!1),void 0===e.planningMode&&(e.planningMode="backward"),e.delayReference||(e.delayReference="planned"),e.axisMode||(e.axisMode="days")}),v.teams.forEach(e=>r(e.id)),!0}}catch(e){console.error("Could not load state from localStorage",e),localStorage.removeItem(h)}return!1}()?g():(g(),m("saved"))},()=>g()):g();let d=document.getElementById("copyright-text");if(d){let e=new Date().getFullYear();d.textContent=`Copyright \xa9 ${e} Daniel Gruner`}});